<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso - Coliseum</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* RESET E VARI√ÅVEIS */
        :root {
            --primary: #ffcf00;
            --primary-dark: #e6b800;
            --secondary: #4361ee;
            --dark: #1a1a1a;
            --dark-light: #2a2a2a;
            --dark-lighter: #333333;
            --light: #ffffff;
            --gray: #888888;
            --success: #4CAF50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196F3;
            
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s ease;
            --gradient-primary: linear-gradient(135deg, #ffcf00 0%, #ff6b00 100%);
            --gradient-dark: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--dark);
            color: var(--light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* BOT√ÉO VOLTAR */
        .btn-voltar {
            position: fixed;
            top: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
            background: var(--dark-light);
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .btn-voltar:hover {
            background: var(--primary);
            color: var(--dark);
            transform: translateX(-5px);
            box-shadow: 0 6px 25px rgba(255, 207, 0, 0.4);
        }

        /* CONTAINER PRINCIPAL */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 30px;
            animation: fadeIn 0.8s ease;
        }

        /* HEADER DO CURSO */
        .curso-header {
            background: var(--gradient-dark);
            border-radius: var(--border-radius-lg);
            padding: 40px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 207, 0, 0.1);
        }

        .curso-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .curso-header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .curso-meta {
            display: flex;
            gap: 25px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--gray);
            font-size: 0.95rem;
        }

        .meta-item i {
            color: var(--primary);
            font-size: 1.1rem;
        }

        /* M√ìDULOS */
        .modulos-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .modulo {
            background: var(--dark-light);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
        }

        .modulo:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(255, 207, 0, 0.2);
        }

        .modulo-header {
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
        }

        .modulo-header:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        .modulo-header h3 {
            color: var(--light);
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modulo-header h3::before {
            content: 'üìö';
            font-size: 1.2rem;
        }

        .modulo-contador {
            background: var(--primary);
            color: var(--dark);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* AULAS */
        .aulas-container {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease, padding 0.3s ease;
        }

        .modulo.expanded .aulas-container {
            padding: 20px;
            max-height: 1000px;
        }

        .aula-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 4px solid transparent;
            position: relative;
        }

        .aula-item:last-child {
            margin-bottom: 0;
        }

        .aula-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
            border-left-color: var(--primary);
        }

        .aula-item.completa {
            background: rgba(76, 175, 80, 0.1);
            border-left-color: var(--success);
        }

        .aula-icone {
            width: 40px;
            height: 40px;
            background: rgba(255, 207, 0, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .aula-item.completa .aula-icone {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .aula-info {
            flex: 1;
        }

        .aula-info h4 {
            color: var(--light);
            font-size: 1.1rem;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .aula-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: var(--gray);
        }

        .aula-status {
            margin-left: auto;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.05);
        }

        .aula-item.completa .aula-status {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 80px 20px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 207, 0, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 0 auto 25px;
            animation: spin 1s linear infinite;
        }

        .loading h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .loading p {
            color: var(--gray);
        }

        /* MODAL DE AULA */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--dark-light);
            margin: 30px auto;
            padding: 0;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: var(--gradient-dark);
            padding: 25px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 30px;
            right: 30px;
            height: 2px;
            background: var(--gradient-primary);
        }

        .modal-header h2 {
            color: var(--primary);
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0;
            flex: 1;
            padding-right: 20px;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--light);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: var(--danger);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        /* CONTROLES DA AULA */
        .aula-controles {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .aula-info-controle {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .aula-tempo {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .btn-concluir {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-concluir:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-concluir:active {
            transform: translateY(0);
        }

        .btn-concluir.concluida {
            background: var(--gray);
            cursor: not-allowed;
        }

        .btn-concluir.concluida:hover {
            transform: none;
            box-shadow: none;
        }

        /* VIDEO CONTAINER */
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* CONTE√öDO DA AULA */
        .conteudo-aula {
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .conteudo-aula h3 {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 207, 0, 0.2);
        }

        .conteudo-aula p, .conteudo-aula li {
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        .conteudo-aula ul, .conteudo-aula ol {
            padding-left: 20px;
            margin-bottom: 20px;
        }

        .conteudo-aula code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--primary);
        }

        /* PROGRESSO */
        .progresso-bar {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--dark-light);
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 207, 0, 0.2);
            z-index: 100;
            animation: slideInRight 0.5s ease;
        }

        .progresso-bar h4 {
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progresso-container {
            width: 200px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progresso-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s ease;
        }

        /* NOTIFICA√á√ÉO DE CONCLU√çDO */
        .notificacao-concluido {
            position: fixed;
            top: 100px;
            right: 30px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
            max-width: 350px;
        }

        .notificacao-concluido i {
            font-size: 1.2rem;
        }
/* Adicione estas regras ao seu CSS existente */

/* Aulas bloqueadas */
.aula-item.bloqueada {
    background: rgba(255, 152, 0, 0.1) !important;
    border-left-color: var(--warning) !important;
    position: relative;
}

.aula-item.bloqueada .aula-icone {
    background: rgba(255, 152, 0, 0.2);
    color: var(--warning);
}

.aula-item.bloqueada .aula-status {
    background: rgba(255, 152, 0, 0.2);
    color: var(--warning);
}

.aula-item.bloqueada:hover {
    transform: none !important;
    border-left-color: var(--warning) !important;
    background: rgba(255, 152, 0, 0.15) !important;
}

.aula-item.bloqueada:hover .aula-info h4 {
    color: #888 !important;
}

/* Notifica√ß√£o de desbloqueio */
.notificacao-desbloqueio {
    position: fixed;
    top: 100px;
    right: 30px;
    background: var(--info);
    color: white;
    padding: 15px 25px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    z-index: 1001;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideInRight 0.5s ease, fadeOut 0.5s ease 3s forwards;
    max-width: 350px;
}

@media (max-width: 768px) {
    .notificacao-desbloqueio {
        top: 80px;
        right: 15px;
        left: 15px;
        max-width: none;
    }
}

@media (max-width: 480px) {
    .notificacao-desbloqueio {
        top: 70px;
        padding: 12px 20px;
    }
}
        /* ANIMA√á√ïES */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(50px);
            }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 207, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 207, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 207, 0, 0); }
        }

        /* RESPONSIVO */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }

            .curso-header {
                padding: 25px 20px;
            }

            .curso-header h1 {
                font-size: 1.8rem;
            }

            .curso-meta {
                gap: 15px;
            }

            .modulo-header {
                padding: 20px;
            }

            .modulo-header h3 {
                font-size: 1.1rem;
            }

            .aula-item {
                padding: 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .aula-status {
                align-self: flex-start;
                margin-left: 0;
            }

            .btn-voltar {
                top: 15px;
                left: 15px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .modal-content {
                margin: 10px auto;
                width: 98%;
                max-height: 95vh;
            }

            .modal-header {
                padding: 20px;
            }

            .modal-header h2 {
                font-size: 1.4rem;
            }

            .modal-body {
                padding: 20px;
            }

            .aula-controles {
                padding: 15px 20px;
                flex-direction: column;
                align-items: stretch;
            }

            .btn-concluir {
                width: 100%;
                justify-content: center;
            }

            .progresso-bar {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
            }

            .progresso-container {
                width: 150px;
            }

            .notificacao-concluido {
                top: 80px;
                right: 15px;
                left: 15px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .curso-header h1 {
                font-size: 1.5rem;
            }

            .meta-item {
                font-size: 0.85rem;
            }

            .modal-header h2 {
                font-size: 1.2rem;
            }

            .progresso-bar {
                bottom: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
            }

            .notificacao-concluido {
                top: 70px;
                padding: 12px 20px;
            }
        }

        /* ESTADO VAZIO */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--primary);
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--light);
        }

        /* SCROLLBAR PERSONALIZADA */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <!-- Bot√£o Voltar -->
    <button class="btn-voltar" onclick="voltarParaCursos()" title="Voltar para Cursos">
        <i class="fas fa-arrow-left"></i>
    </button>
    
    <!-- Progresso Fixo -->
    <div class="progresso-bar" id="progresso-bar">
        <h4>Progresso do Curso</h4>
        <div class="progresso-container">
            <div class="progresso-fill" id="progresso-fill"></div>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="container">
        <!-- Header do Curso -->
        <div class="curso-header">
            <h1 id="curso-titulo">Carregando...</h1>
            <p id="curso-descricao"></p>
            <div class="curso-meta" id="curso-meta">
                <!-- Metadados ser√£o preenchidos via JS -->
            </div>
        </div>
        
        <!-- M√≥dulos -->
        <div id="modulos-container">
            <div class="loading">
                <div class="spinner"></div>
                <h3>Carregando conte√∫do do curso...</h3>
                <p>Preparando sua experi√™ncia de aprendizado</p>
            </div>
        </div>
    </div>

    <!-- Modal de Aula -->
    <div class="modal" id="aula-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="aula-titulo"></h2>
                <button class="modal-close" onclick="fecharAula()" title="Fechar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="aula-conteudo">
                <!-- Conte√∫do ser√° carregado aqui -->
            </div>
            
            <!-- CONTROLES DA AULA (COM BOT√ÉO DE CONCLUIR) -->
            <div class="aula-controles" id="aula-controles" style="display: none;">
                <div class="aula-info-controle">
                    <div class="aula-tempo">
                        <i class="fas fa-clock"></i>
                        <span id="aula-duracao">--:--</span>
                    </div>
                    <div class="aula-tempo">
                        <i class="fas fa-check-circle"></i>
                        <span id="aula-estado">N√£o iniciada</span>
                    </div>
                </div>
                <button class="btn-concluir" id="btn-concluir-aula" onclick="marcarAulaConcluida()">
                    <i class="fas fa-check"></i>
                    <span>Marcar como Conclu√≠da</span>
                </button>
            </div>
        </div>
    </div>

<script>
    // VARI√ÅVEIS GLOBAIS
    let aulaAtualId = null;
    let aulaAtualConcluida = false;
    let gerenciador = null;

    // FUN√á√ÉO VOLTAR
    function voltarParaCursos() {
        console.log('Voltando para cursos...');
        const urlParams = new URLSearchParams(window.location.search);
        const from = urlParams.get('from');
        
        if (from === 'extras') {
            window.location.href = 'CursosExtras/indexEX.html';
        } else {
            window.history.back();
        }
    }

    // FUN√á√ïES AUXILIARES PARA MODAL DE SOLICITA√á√ÉO
    function fecharModalSolicitacao() {
        const modal = document.getElementById('solicitacao-modal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            setTimeout(() => {
                if (modal.parentNode) modal.remove();
            }, 300);
        }
    }

    function mostrarNotificacaoSolicitacaoEnviada() {
        const notificacao = document.createElement('div');
        notificacao.className = 'notificacao-solicitacao';
        notificacao.innerHTML = `
            <i class="fas fa-paper-plane"></i>
            <div>
                <strong>Solicita√ß√£o Enviada!</strong>
                <div style="font-size: 0.85rem; opacity: 0.9;">Aguardando aprova√ß√£o do administrador</div>
            </div>
        `;
        document.body.appendChild(notificacao);
        
        setTimeout(() => {
            if (notificacao.parentNode) notificacao.remove();
        }, 3500);
    }

    function showGlobalLoading(show) {
        if (show) {
            document.body.style.cursor = 'wait';
        } else {
            document.body.style.cursor = 'default';
        }
    }

    // GERENCIADOR PRINCIPAL COM BLOQUEIO DE AULAS
    class GerenciadorCursos {
        constructor() {
            this.API_BASE = 'https://coliseum-api.onrender.com/api';
            this.usuarioId = this.obterUsuarioId();
            this.cursoId = this.obterCursoId();
            this.aulasConcluidas = this.carregarProgresso();
            this.totalAulas = 0;
            this.aulasCarregadas = 0;
            this.cursoData = null;
            this.aulasMap = new Map();
            this.aulasAutorizadas = new Set(); // Armazena aulas autorizadas pelo ADM
            this.bloqueioProgressivo = true;
        }

        obterUsuarioId() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const usuarioId = urlParams.get('usuarioId');
                
                if (usuarioId) {
                    localStorage.setItem('usuarioId', usuarioId);
                    return usuarioId;
                }
                
                return localStorage.getItem('usuarioId') || '1';
            } catch (e) {
                console.error('Erro:', e);
                return '1';
            }
        }

        obterCursoId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        carregarProgresso() {
            const progresso = localStorage.getItem(`progresso_${this.usuarioId}_${this.cursoId}`);
            return progresso ? JSON.parse(progresso) : [];
        }

        carregarAutorizacoes() {
            const autorizacoes = localStorage.getItem(`autorizacoes_${this.usuarioId}_${this.cursoId}`);
            return autorizacoes ? JSON.parse(autorizacoes) : [];
        }

        salvarProgresso() {
            localStorage.setItem(`progresso_${this.usuarioId}_${this.cursoId}`, 
                                JSON.stringify(this.aulasConcluidas));
            this.atualizarProgressoBar();
        }

        salvarAutorizacoes() {
            localStorage.setItem(`autorizacoes_${this.usuarioId}_${this.cursoId}`,
                                JSON.stringify(Array.from(this.aulasAutorizadas)));
        }

        marcarAulaConcluida(aulaId) {
            if (!this.aulasConcluidas.includes(aulaId)) {
                this.aulasConcluidas.push(aulaId);
                this.salvarProgresso();
                
                this.mostrarNotificacaoConcluido();
                this.atualizarInterfaceAula(aulaId);
                
                return true;
            }
            return false;
        }

        adicionarAutorizacao(aulaId) {
            if (!this.aulasAutorizadas.has(aulaId)) {
                this.aulasAutorizadas.add(aulaId);
                this.salvarAutorizacoes();
                console.log(`‚úÖ Aula ${aulaId} autorizada pelo ADM`);
                return true;
            }
            return false;
        }

   verificarAulaAutorizada(aulaId) {
    console.log('Verificando autoriza√ß√£o para aula', aulaId);
    
    if (this.aulasConcluidas.includes(aulaId)) {
        console.log('‚úÖ Aula j√° conclu√≠da - acesso permitido para revis√£o');
        return true;
    }
    
    const aula = this.encontrarAula(aulaId);
    
    if (aula && aula.aulaIndex === 0) {
        console.log('‚úÖ Primeira aula do m√≥dulo - acesso liberado automaticamente');
        return true;
    }
    
    if (this.aulasAutorizadas.has(aulaId)) {
        console.log('‚úÖ Aula autorizada pelo ADM');
        return true;
    }
    
    const aulaAnterior = this.encontrarAulaAnterior(aulaId);
    if (aulaAnterior && this.aulasConcluidas.includes(aulaAnterior.id)) {
        console.log('‚ö†Ô∏è Aula anterior conclu√≠da, mas ainda n√£o autorizada pelo ADM');
        return false; 
    }
    
    console.log('‚ùå Aula N√ÉO autorizada');
    return false;
}

        desmarcarAulaConcluida(aulaId) {
            const index = this.aulasConcluidas.indexOf(aulaId);
            if (index > -1) {
                this.aulasConcluidas.splice(index, 1);
                this.salvarProgresso();
                this.atualizarInterfaceAula(aulaId, false);
                return true;
            }
            return false;
        }

        mostrarNotificacaoConcluido() {
            const notificacaoAnterior = document.querySelector('.notificacao-concluido');
            if (notificacaoAnterior) {
                notificacaoAnterior.remove();
            }

            const notificacao = document.createElement('div');
            notificacao.className = 'notificacao-concluido';
            notificacao.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <div>
                    <strong>Aula Conclu√≠da!</strong>
                    <div style="font-size: 0.85rem; opacity: 0.9;">Progresso atualizado com sucesso</div>
                </div>
            `;

            document.body.appendChild(notificacao);

            setTimeout(() => {
                if (notificacao.parentNode) {
                    notificacao.remove();
                }
            }, 3000);
        }

        calcularProgresso() {
            if (this.totalAulas === 0) return 0;
            return Math.round((this.aulasConcluidas.length / this.totalAulas) * 100);
        }

        atualizarProgressoBar() {
            const progresso = this.calcularProgresso();
            const progressoFill = document.getElementById('progresso-fill');
            if (progressoFill) {
                progressoFill.style.width = `${progresso}%`;
            }
        }
        
        async carregarCurso() {
            try {
                if (!this.cursoId) {
                    this.mostrarErro('Curso n√£o especificado');
                    return;
                }

                console.log('Buscando curso completo:', this.cursoId);
                
                const response = await fetch(`${this.API_BASE}/cursos/${this.cursoId}`);
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status} ao carregar curso`);
                }
                
                const data = await response.json();
                
                if (data.success && data.curso) {
                    this.cursoData = data.curso;
                    this.exibirCurso(data.curso);
                    
                    this.bloqueioProgressivo = data.curso.bloqueioProgressivo !== false;
                    
                    // Carregar autoriza√ß√µes salvas
                    const autorizacoesSalvas = this.carregarAutorizacoes();
                    this.aulasAutorizadas = new Set(autorizacoesSalvas);
                    
                    // Tentar carregar autoriza√ß√µes da API
                    await this.carregarAutorizacoesDaAPI();
                    
                    this.processarAulas(data.curso.modulos || []);
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('Erro ao carregar curso:', error);
                this.mostrarErro(error.message);
            }
        }

        async carregarAutorizacoesDaAPI() {
            try {
                console.log('Carregando autoriza√ß√µes da API...');
                
                // Tentar carregar autoriza√ß√µes do usu√°rio para este curso
                const response = await fetch(`${this.API_BASE}/autorizacoes/${this.usuarioId}/${this.cursoId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Autoriza√ß√µes da API:', data);
                    
                    if (data.success && data.autorizacoes) {
                        // Processar autoriza√ß√µes da API
                        data.autorizacoes.forEach(auth => {
                            if (auth.aulaId) {
                                this.aulasAutorizadas.add(parseInt(auth.aulaId));
                            }
                        });
                        this.salvarAutorizacoes();
                        console.log('Autoriza√ß√µes carregadas da API:', Array.from(this.aulasAutorizadas));
                    }
                } else {
                    console.log('Nenhuma autoriza√ß√£o encontrada na API');
                }
            } catch (error) {
                console.error('Erro ao carregar autoriza√ß√µes da API:', error);
            }
        }
        
        encontrarAulaAnterior(aulaId) {
            const aulaAtual = this.encontrarAula(aulaId);
            if (!aulaAtual) return null;

            const { moduloIndex, aulaIndex } = aulaAtual;
            
            if (aulaIndex > 0) {
                const modulo = this.cursoData.modulos[moduloIndex];
                return modulo.aulas[aulaIndex - 1];
            } else if (moduloIndex > 0) {
                const moduloAnterior = this.cursoData.modulos[moduloIndex - 1];
                if (moduloAnterior.aulas && moduloAnterior.aulas.length > 0) {
                    return moduloAnterior.aulas[moduloAnterior.aulas.length - 1];
                }
            }
            
            return null; 
        }

        processarAulas(modulos) {
            console.log('Processando m√≥dulos:', modulos);
            
            this.aulasMap.clear();
            this.totalAulas = 0;
            
            modulos.forEach((modulo, moduloIndex) => {
                if (modulo.aulas && Array.isArray(modulo.aulas)) {
                    modulo.aulas.forEach((aula, aulaIndex) => {
                        if (aula && aula.id) {
                            aula.moduloIndex = moduloIndex;
                            aula.aulaIndex = aulaIndex;
                            aula.primeiraDoModulo = (aulaIndex === 0);
                            this.aulasMap.set(aula.id, aula);
                            this.totalAulas++;
                        }
                    });
                }
            });
            
            console.log(`Total de aulas mapeadas: ${this.aulasMap.size}`);
            console.log('Aulas autorizadas:', Array.from(this.aulasAutorizadas));
            
            this.exibirModulosComAulas(modulos);
            this.atualizarProgressoBar();
        }

        exibirModulosComAulas(modulos) {
            const container = document.getElementById('modulos-container');
            
            if (!container) {
                console.error('Container de m√≥dulos n√£o encontrado!');
                return;
            }
            
            if (!modulos || modulos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-graduation-cap"></i>
                        <h3>Nenhum m√≥dulo encontrado</h3>
                        <p>Este curso ainda n√£o possui conte√∫do dispon√≠vel.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            for (let i = 0; i < modulos.length; i++) {
                const modulo = modulos[i];
                const aulasCount = modulo.aulas?.length || 0;
                
                html += `
                    <div class="modulo" id="modulo-${i}">
                        <div class="modulo-header" onclick="toggleModulo(${i})">
                            <h3>${this.escapeHtml(modulo.titulo || `M√≥dulo ${i + 1}`)}</h3>
                            <span class="modulo-contador">${aulasCount} aula${aulasCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="aulas-container" id="modulo-aulas-${i}">
                            ${this.gerarListaAulas(modulo.aulas || [])}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        gerarListaAulas(aulas) {
            if (!aulas || aulas.length === 0) {
                return '<div style="padding:20px;color:#888;text-align:center;">Nenhuma aula dispon√≠vel neste m√≥dulo</div>';
            }

            let aulasHTML = '';
            
            for (let i = 0; i < aulas.length; i++) {
                const aula = aulas[i];
                if (!aula || !aula.id) continue;
                
                const concluida = this.aulasConcluidas.includes(aula.id);
                const primeiraAula = (i === 0);
                const autorizada = this.verificarAulaAutorizada(aula.id);
                const aulaIcon = aula.videoUrl ? 'fas fa-play-circle' : 'fas fa-book';
                const bloqueada = !autorizada && !concluida;
                
                aulasHTML += `
                    <div class="aula-item ${concluida ? 'completa' : ''} ${bloqueada ? 'bloqueada' : ''}" 
                         onclick="${bloqueada ? '' : `iniciarAula(${aula.id})`}"
                         data-aula-id="${aula.id}"
                         data-aula-autorizada="${autorizada}"
                         data-primeira-aula="${primeiraAula}"
                         style="${bloqueada ? 'cursor: not-allowed;' : ''}">
                        <div class="aula-icone">
                            ${bloqueada ? 
                                '<i class="fas fa-lock" style="color: var(--warning);"></i>' : 
                                `<i class="${aulaIcon}"></i>`
                            }
                        </div>
                        <div class="aula-info">
                            <h4 style="${bloqueada ? 'color: #888;' : ''}">
                                ${this.escapeHtml(aula.titulo || `Aula ${aula.id}`)}
                                ${primeiraAula && !concluida ? 
                                    '<span style="color: var(--success); font-size: 0.8em; margin-left: 8px;">(In√≠cio)</span>' : 
                                    ''}
                                ${bloqueada ? 
                                    '<span style="color: var(--warning); font-size: 0.8em; margin-left: 8px;">(Bloqueada)</span>' : 
                                    ''}
                            </h4>
                            <div class="aula-meta">
                                <span><i class="fas fa-clock"></i> ${aula.duracao || '10:00'} min</span>
                                ${aula.nivel ? `<span><i class="fas fa-chart-bar"></i> ${aula.nivel}</span>` : ''}
                            </div>
                        </div>
                        <div class="aula-status">
                            ${concluida ? 
                                '<i class="fas fa-check"></i> Conclu√≠da' : 
                                bloqueada ? 
                                    '<i class="fas fa-lock"></i> Bloqueada' : 
                                    primeiraAula ? 
                                        '<i class="fas fa-play-circle"></i> Dispon√≠vel' : 
                                        '<i class="fas fa-user-shield"></i> Autorizada'
                            }
                        </div>
                        ${bloqueada && !primeiraAula ? `
                            <div class="aula-tooltip" style="position: absolute; top: 50%; right: 70px; transform: translateY(-50%);">
                                <i class="fas fa-info-circle" style="color: var(--warning); cursor: help;" 
                                   title="Esta aula est√° bloqueada. Aguarde autoriza√ß√£o do administrador."></i>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            return aulasHTML;
        }

        encontrarAula(aulaId) {
            if (this.aulasMap.has(aulaId)) {
                return this.aulasMap.get(aulaId);
            }
            
            if (this.cursoData && this.cursoData.modulos) {
                for (const modulo of this.cursoData.modulos) {
                    if (modulo.aulas) {
                        const aula = modulo.aulas.find(a => a.id == aulaId);
                        if (aula) return aula;
                    }
                }
            }
            
            return null;
        }

        exibirCurso(curso) {
            const tituloElement = document.getElementById('curso-titulo');
            const descricaoElement = document.getElementById('curso-descricao');
            const metaContainer = document.getElementById('curso-meta');
            
            if (tituloElement) {
                tituloElement.textContent = curso.titulo || 'Curso Sem T√≠tulo';
            }
            
            if (descricaoElement) {
                descricaoElement.textContent = curso.descricao || '';
            }
            
            document.title = `${curso.titulo || 'Curso'} - Coliseum`;

            if (metaContainer) {
                const totalAulas = curso.modulos ? 
                    curso.modulos.reduce((total, modulo) => total + (modulo.aulas?.length || 0), 0) : 0;
                
                metaContainer.innerHTML = `
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>${curso.duracao || '--'} horas</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-layer-group"></i>
                        <span>${curso.modulos?.length || 0} m√≥dulos</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-book"></i>
                        <span>${totalAulas} aulas</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-graduation-cap"></i>
                        <span>${curso.nivel || 'Todos os n√≠veis'}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-user-shield"></i>
                        <span>Sistema de Autoriza√ß√£o</span>
                    </div>
                `;
            }
        }

        async carregarConteudoAula(aulaId) {
            try {
                console.log('Carregando conte√∫do da aula:', aulaId);
                
                const autorizada = this.verificarAulaAutorizada(aulaId);
                
                if (!autorizada) {
                    const aulaAnterior = this.encontrarAulaAnterior(aulaId);
                    return this.conteudoAulaBloqueada(aulaId, aulaAnterior);
                }
                
                let aula = this.encontrarAula(aulaId);
                
                if (!aula) {
                    console.log('Aula n√£o encontrada no cache');
                    throw new Error('Aula n√£o encontrada');
                }
                
                aulaAtualId = aulaId;
                aulaAtualConcluida = this.aulasConcluidas.includes(aulaId);
                
                this.atualizarControlesAula(aula);
                
                return this.formatarConteudoAula(aula);
                
            } catch (error) {
                console.error('Erro ao carregar conte√∫do:', error);
                return this.conteudoErro(error);
            }
        }

        conteudoAulaBloqueada(aulaId, aulaAnterior) {
            const aula = this.encontrarAula(aulaId);
            const cursoTitulo = this.cursoData?.titulo || 'Curso';
            const primeiraAula = aula && aula.aulaIndex === 0;
            
            // Se for primeira aula, n√£o deve estar bloqueada
            if (primeiraAula) {
                return `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h3 style="color: var(--light); margin-bottom: 15px;">Bem-vindo √† Aula Inicial!</h3>
                        <p style="color: var(--gray); margin-bottom: 10px;">
                            <strong>"${this.escapeHtml(aula?.titulo || 'Aula')}"</strong> est√° dispon√≠vel.
                        </p>
                        <p style="color: var(--gray); margin-bottom: 25px;">
                            Esta √© a primeira aula do m√≥dulo. Clique no bot√£o abaixo para come√ßar.
                        </p>
                        <button onclick="iniciarAula(${aulaId})" style="
                            padding: 12px 30px;
                            background: var(--primary);
                            color: var(--dark);
                            border: none;
                            border-radius: var(--border-radius-sm);
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 1.1rem;
                            margin-top: 20px;
                        ">
                            <i class="fas fa-play"></i> Iniciar Aula
                        </button>
                    </div>
                `;
            }
            
            return `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 4rem; color: var(--warning); margin-bottom: 20px;">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h3 style="color: var(--light); margin-bottom: 15px;">Aula Bloqueada</h3>
                    <p style="color: var(--gray); margin-bottom: 10px;">
                        <strong>"${this.escapeHtml(aula?.titulo || 'Aula')}"</strong> est√° bloqueada.
                    </p>
                    <p style="color: var(--gray); margin-bottom: 25px;">
                        ${aulaAnterior ? 
                            `Para acessar esta aula, voc√™ precisa concluir a aula anterior e aguardar autoriza√ß√£o do administrador.` : 
                            `Esta aula requer autoriza√ß√£o especial do administrador.`}
                    </p>
                    
                    ${aulaAnterior ? `
                        <div style="margin-top: 30px; padding: 20px; background: rgba(255, 207, 0, 0.1); border-radius: var(--border-radius); max-width: 500px; margin-left: auto; margin-right: auto;">
                            <h4 style="color: var(--primary); margin-bottom: 15px;">
                                <i class="fas fa-arrow-left"></i> Pr√©-requisito Necess√°rio
                            </h4>
                            <div style="text-align: left;">
                                <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: var(--border-radius-sm);">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <div style="width: 40px; height: 40px; background: rgba(255, 207, 0, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-play-circle" style="color: var(--primary);"></i>
                                        </div>
                                        <div>
                                            <strong style="color: var(--light);">${this.escapeHtml(aulaAnterior.titulo)}</strong>
                                            <div style="color: var(--gray); font-size: 0.9rem;">
                                                ${aulaAnterior.duracao || '10:00'} min
                                            </div>
                                        </div>
                                    </div>
                                    ${aulaAnterior.descricao ? `
                                        <p style="color: #e0e0e0; font-size: 0.9rem; margin-top: 10px;">
                                            ${this.escapeHtml(aulaAnterior.descricao)}
                                        </p>
                                    ` : ''}
                                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            ${this.aulasConcluidas.includes(aulaAnterior.id) ? 
                                                `<span style="color: var(--success);"><i class="fas fa-check-circle"></i> Conclu√≠da</span>` :
                                                `<span style="color: var(--warning);"><i class="fas fa-clock"></i> Pendente</span>`
                                            }
                                        </div>
                                        <button onclick="iniciarAula(${aulaAnterior.id})" style="
                                            padding: 8px 20px;
                                            background: var(--primary);
                                            color: var(--dark);
                                            border: none;
                                            border-radius: var(--border-radius-sm);
                                            cursor: pointer;
                                            font-weight: 600;
                                            display: inline-flex;
                                            align-items: center;
                                            gap: 8px;
                                        ">
                                            <i class="fas fa-play"></i>
                                            ${this.aulasConcluidas.includes(aulaAnterior.id) ? 'Revisar Aula' : 'Concluir Aula'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 30px; padding: 20px; background: rgba(67, 97, 238, 0.1); border-radius: var(--border-radius); max-width: 500px; margin-left: auto; margin-right: auto;">
                        <h4 style="color: var(--secondary); margin-bottom: 10px;">
                            <i class="fas fa-user-shield"></i> Autoriza√ß√£o Administrativa
                        </h4>
                        <p style="color: var(--gray); margin-bottom: 15px;">
                            Esta aula requer autoriza√ß√£o especial do administrador.
                        </p>
                        <p style="color: var(--info); margin-bottom: 15px; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i> Ao concluir a aula anterior, uma solicita√ß√£o autom√°tica ser√° enviada ao administrador.
                        </p>
                    </div>
                    
                    <div style="margin-top: 40px; color: var(--gray); font-size: 0.9rem;">
                        <p>Curso: <strong>${this.escapeHtml(cursoTitulo)}</strong></p>
                        <p>Entre em contato com o administrador se precisar de acesso especial.</p>
                    </div>
                </div>
            `;
        }

        atualizarControlesAula(aula) {
            const controles = document.getElementById('aula-controles');
            const duracaoElement = document.getElementById('aula-duracao');
            const estadoElement = document.getElementById('aula-estado');
            const btnConcluir = document.getElementById('btn-concluir-aula');
            
            if (controles) {
                controles.style.display = 'flex';
            }
            
            if (duracaoElement && aula.duracao) {
                duracaoElement.textContent = aula.duracao;
            }
            
            if (estadoElement) {
                const concluida = this.aulasConcluidas.includes(aula.id);
                const primeiraAula = aula.aulaIndex === 0;
                const autorizada = this.verificarAulaAutorizada(aula.id);
                
                if (concluida) {
                    estadoElement.textContent = 'Conclu√≠da';
                    estadoElement.style.color = 'var(--success)';
                } else if (primeiraAula) {
                    estadoElement.textContent = 'Dispon√≠vel para in√≠cio';
                    estadoElement.style.color = 'var(--primary)';
                } else if (autorizada) {
                    estadoElement.textContent = 'Autorizada pelo ADM';
                    estadoElement.style.color = 'var(--info)';
                } else {
                    estadoElement.textContent = 'Aguardando autoriza√ß√£o';
                    estadoElement.style.color = 'var(--warning)';
                }
            }
            
            if (btnConcluir) {
                const concluida = this.aulasConcluidas.includes(aula.id);
                
                if (concluida) {
                    btnConcluir.innerHTML = '<i class="fas fa-check-double"></i> <span>Aula Conclu√≠da</span>';
                    btnConcluir.classList.add('concluida');
                    btnConcluir.disabled = true;
                } else {
                    btnConcluir.innerHTML = '<i class="fas fa-check"></i> <span>Marcar como Conclu√≠da</span>';
                    btnConcluir.classList.remove('concluida');
                    btnConcluir.disabled = false;
                }
            }
        }

        atualizarInterfaceAula(aulaId, concluida = true) {
            const aulaElement = document.querySelector(`[data-aula-id="${aulaId}"]`);
            if (aulaElement) {
                if (concluida) {
                    aulaElement.classList.remove('bloqueada');
                    aulaElement.classList.add('completa');
                    
                    const statusElement = aulaElement.querySelector('.aula-status');
                    const iconeElement = aulaElement.querySelector('.aula-icone');
                    
                    if (statusElement) {
                        statusElement.innerHTML = '<i class="fas fa-check"></i> Conclu√≠da';
                    }
                    if (iconeElement) {
                        iconeElement.innerHTML = '<i class="fas fa-check-circle"></i>';
                    }
                    
                    aulaElement.onclick = () => iniciarAula(aulaId);
                    aulaElement.style.cursor = 'pointer';
                    
                    const tooltip = aulaElement.querySelector('.aula-tooltip');
                    if (tooltip) {
                        tooltip.remove();
                    }
                    
                    const tituloElement = aulaElement.querySelector('.aula-info h4');
                    if (tituloElement) {
                        tituloElement.style.color = '';
                        const spanInicio = tituloElement.querySelector('span[style*="color: var(--success)"]');
                        const spanBloqueado = tituloElement.querySelector('span[style*="color: var(--warning)"]');
                        if (spanInicio) spanInicio.remove();
                        if (spanBloqueado) spanBloqueado.remove();
                    }
                } else {
                    aulaElement.classList.remove('completa');
                    const statusElement = aulaElement.querySelector('.aula-status');
                    const iconeElement = aulaElement.querySelector('.aula-icone');
                    const aula = this.encontrarAula(aulaId);
                    
                    if (statusElement) {
                        const primeiraAula = aula && aula.aulaIndex === 0;
                        const autorizada = this.verificarAulaAutorizada(aulaId);
                        
                        if (primeiraAula) {
                            statusElement.innerHTML = '<i class="fas fa-play-circle"></i> Dispon√≠vel';
                        } else if (autorizada) {
                            statusElement.innerHTML = '<i class="fas fa-user-shield"></i> Autorizada';
                        } else {
                            statusElement.innerHTML = '<i class="fas fa-lock"></i> Bloqueada';
                        }
                    }
                    if (iconeElement && aula) {
                        iconeElement.innerHTML = aula.videoUrl ? '<i class="fas fa-play-circle"></i>' : '<i class="fas fa-book"></i>';
                    }
                }
            }
            
            if (aulaId === aulaAtualId) {
                const btnConcluir = document.getElementById('btn-concluir-aula');
                const estadoElement = document.getElementById('aula-estado');
                
                if (concluida) {
                    if (btnConcluir) {
                        btnConcluir.innerHTML = '<i class="fas fa-check-double"></i> <span>Aula Conclu√≠da</span>';
                        btnConcluir.classList.add('concluida');
                        btnConcluir.disabled = true;
                    }
                    if (estadoElement) {
                        estadoElement.textContent = 'Conclu√≠da';
                        estadoElement.style.color = 'var(--success)';
                    }
                } else {
                    if (btnConcluir) {
                        btnConcluir.innerHTML = '<i class="fas fa-check"></i> <span>Marcar como Conclu√≠da</span>';
                        btnConcluir.classList.remove('concluida');
                        btnConcluir.disabled = false;
                    }
                    if (estadoElement) {
                        const aula = this.encontrarAula(aulaId);
                        const primeiraAula = aula && aula.aulaIndex === 0;
                        const autorizada = this.verificarAulaAutorizada(aulaId);
                        
                        if (primeiraAula) {
                            estadoElement.textContent = 'Dispon√≠vel para in√≠cio';
                            estadoElement.style.color = 'var(--primary)';
                        } else if (autorizada) {
                            estadoElement.textContent = 'Autorizada pelo ADM';
                            estadoElement.style.color = 'var(--info)';
                        } else {
                            estadoElement.textContent = 'Aguardando autoriza√ß√£o';
                            estadoElement.style.color = 'var(--warning)';
                        }
                    }
                }
            }
            
            this.atualizarProgressoBar();
        }

        mostrarNotificacaoDesbloqueio(aulaId) {
            const aula = this.encontrarAula(aulaId);
            if (!aula) return;

            const notificacaoAnterior = document.querySelector('.notificacao-desbloqueio');
            if (notificacaoAnterior) {
                notificacaoAnterior.remove();
            }

            const notificacao = document.createElement('div');
            notificacao.className = 'notificacao-desbloqueio';
            notificacao.innerHTML = `
                <i class="fas fa-unlock"></i>
                <div>
                    <strong>Nova Aula Autorizada!</strong>
                    <div style="font-size: 0.85rem; opacity: 0.9;">"${this.escapeHtml(aula.titulo)}" foi liberada pelo administrador</div>
                </div>
            `;

            document.body.appendChild(notificacao);

            setTimeout(() => {
                if (notificacao.parentNode) {
                    notificacao.remove();
                }
            }, 3500);
        }

        extrairYouTubeId(url) {
            if (!url) return null;
            
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
                /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/,
                /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        formatarConteudoAula(aula) {
            let conteudo = '';
            
            const tituloElement = document.getElementById('aula-titulo');
            if (tituloElement) {
                tituloElement.textContent = aula.titulo || `Aula ${aula.id}`;
            }
            
            if (aula.videoUrl) {
                const videoId = this.extrairYouTubeId(aula.videoUrl);
                
                if (videoId) {
                    const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    
                    conteudo += `
                        <div class="video-container">
                            <iframe src="${embedUrl}" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen
                                    loading="lazy">
                            </iframe>
                        </div>
                    `;
                } else {
                    conteudo += `
                        <div class="conteudo-aula">
                            <h3><i class="fas fa-video"></i> Conte√∫do de V√≠deo</h3>
                            <p>Link do v√≠deo: <a href="${this.escapeHtml(aula.videoUrl)}" target="_blank" style="color:var(--primary);">${this.escapeHtml(aula.videoUrl)}</a></p>
                            <small style="color:var(--gray);">Clique no link para assistir em outra aba</small>
                        </div>
                    `;
                }
            }
            
            if (aula.conteudo) {
                conteudo += `
                    <div class="conteudo-aula">
                        <h3><i class="fas fa-file-alt"></i> Conte√∫do da Aula</h3>
                        <div>${this.formatarTexto(aula.conteudo)}</div>
                    </div>
                `;
            } else if (aula.descricao) {
                conteudo += `
                    <div class="conteudo-aula">
                        <h3><i class="fas fa-info-circle"></i> Descri√ß√£o</h3>
                        <p>${this.escapeHtml(aula.descricao)}</p>
                    </div>
                `;
            }
            
            if (!conteudo) {
                conteudo = this.conteudoPadrao(aula);
            }
            
            return conteudo;
        }

        conteudoPadrao(aula) {
            const primeiraAula = aula.aulaIndex === 0;
            const autorizada = this.verificarAulaAutorizada(aula.id);
            
            return `
                <div class="empty-state">
                    <i class="fas fa-graduation-cap"></i>
                    <h3>${this.escapeHtml(aula.titulo || `Aula ${aula.id}`)}</h3>
                    <p>${primeiraAula ? 
                        'Esta √© a primeira aula do m√≥dulo. Bem-vindo!' : 
                        autorizada ? 
                            'Aula autorizada pelo administrador. Bom estudo!' : 
                            'Esta aula aguarda autoriza√ß√£o do administrador.'}</p>
                    ${aula.videoUrl ? `
                        <div style="margin-top: 20px;">
                            <a href="${this.escapeHtml(aula.videoUrl)}" target="_blank" 
                               style="display:inline-flex; align-items:center; gap:10px; 
                                      padding:12px 24px; background:var(--primary); 
                                      color:var(--dark); border-radius:var(--border-radius-sm);
                                      text-decoration:none; font-weight:600;">
                                <i class="fas fa-external-link-alt"></i>
                                Assistir V√≠deo Externo
                            </a>
                        </div>
                    ` : ''}
                    ${primeiraAula ? `
                        <div style="margin-top: 20px; padding: 15px; background: rgba(255, 207, 0, 0.1); border-radius: var(--border-radius-sm); max-width: 500px; margin: 0 auto;">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">
                                <i class="fas fa-lightbulb"></i> Dica Importante
                            </h4>
                            <p style="color: #e0e0e0; font-size: 0.9rem; margin-bottom: 0;">
                                Conclua esta aula para enviar solicita√ß√£o autom√°tica para a pr√≥xima aula.
                            </p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        conteudoErro(error) {
            return `
                <div style="text-align:center; padding: 50px;">
                    <div style="font-size:4rem; color:var(--danger); margin-bottom:20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 style="color:var(--light); margin-bottom:15px;">Erro ao Carregar Conte√∫do</h3>
                    <p style="color:var(--gray); margin-bottom:10px;">${this.escapeHtml(error.message)}</p>
                    <button onclick="location.reload()" style="
                        margin-top:20px; 
                        padding:12px 24px; 
                        background:var(--primary); 
                        color:var(--dark); 
                        border:none; 
                        border-radius:var(--border-radius-sm);
                        cursor:pointer;
                        font-weight:600;
                    ">
                        <i class="fas fa-redo"></i> Recarregar P√°gina
                    </button>
                </div>
            `;
        }

        formatarTexto(texto) {
            if (!texto) return '';
            
            return this.escapeHtml(texto)
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/```(.*?)```/gs, '<pre style="background:rgba(0,0,0,0.3);padding:15px;border-radius:8px;overflow:auto;"><code>$1</code></pre>')
                .replace(/`(.*?)`/g, '<code style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;">$1</code>');
        }

        escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        mostrarErro(mensagem) {
            const container = document.getElementById('modulos-container');
            if (!container) return;
            
            container.innerHTML = `
                <div style="background:rgba(244,67,54,0.1); border:1px solid rgba(244,67,54,0.3); border-radius:var(--border-radius); padding:30px; text-align:center;">
                    <div style="font-size:3rem; color:var(--danger); margin-bottom:20px;">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <h3 style="color:var(--light); margin-bottom:15px;">Erro ao Carregar Curso</h3>
                    <p style="color:var(--gray); margin-bottom:25px;">${this.escapeHtml(mensagem)}</p>
                    <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                        <button onclick="location.reload()" style="
                            padding:12px 24px; 
                            background:var(--primary); 
                            color:var(--dark); 
                            border:none; 
                            border-radius:var(--border-radius-sm);
                            cursor:pointer;
                            font-weight:600;
                            display:flex;
                            align-items:center;
                            gap:8px;
                        ">
                            <i class="fas fa-redo"></i> Tentar Novamente
                        </button>
                        <button onclick="voltarParaCursos()" style="
                            padding:12px 24px; 
                            background:var(--dark-lighter); 
                            color:var(--light); 
                            border:1px solid rgba(255,255,255,0.1); 
                            border-radius:var(--border-radius-sm);
                            cursor:pointer;
                            font-weight:600;
                            display:flex;
                            align-items:center;
                            gap:8px;
                        ">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                </div>
            `;
        }
    }

    // FUN√á√ïES AUXILIARES PARA SOLICITA√á√ÉO AUTOM√ÅTICA
    async function enviarSolicitacaoParaProximaAula(aulaIdConcluida) {
        try {
            const gerenciador = window.gerenciador;
            
            // Encontrar a pr√≥xima aula
            const proximaAula = encontrarProximaAula(aulaIdConcluida);
            
            if (!proximaAula) {
                console.log('‚ÑπÔ∏è N√£o h√° pr√≥xima aula ou √© a √∫ltima');
                return;
            }
            
            console.log(`üì§ Aula conclu√≠da. Enviando solicita√ß√£o para pr√≥xima aula: ${proximaAula.id} - ${proximaAula.titulo}`);
            
            // Criar motivo autom√°tico
            const motivo = `Aluno completou a aula "${gerenciador.encontrarAula(aulaIdConcluida)?.titulo || 'anterior'}" e aguarda autoriza√ß√£o para continuar.`;
            
            // Enviar solicita√ß√£o para o administrador
            const solicitacaoEnviada = await enviarSolicitacaoParaAdm(
                proximaAula.id,
                'autorizacao_automatica',
                motivo
            );
            
            if (solicitacaoEnviada) {
                mostrarNotificacaoSolicitacaoAutomatica(proximaAula);
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao enviar solicita√ß√£o para pr√≥xima aula:', error);
        }
    }

    function encontrarProximaAula(aulaIdAtual) {
        const gerenciador = window.gerenciador;
        const aulaAtual = gerenciador.encontrarAula(aulaIdAtual);
        
        if (!aulaAtual) return null;
        
        const { moduloIndex, aulaIndex } = aulaAtual;
        const curso = gerenciador.cursoData;
        
        // Verificar se h√° pr√≥xima aula no mesmo m√≥dulo
        if (curso.modulos[moduloIndex].aulas && 
            aulaIndex + 1 < curso.modulos[moduloIndex].aulas.length) {
            return curso.modulos[moduloIndex].aulas[aulaIndex + 1];
        }
        
        // Verificar pr√≥ximo m√≥dulo
        else if (moduloIndex + 1 < curso.modulos.length) {
            const proximoModulo = curso.modulos[moduloIndex + 1];
            if (proximoModulo.aulas && proximoModulo.aulas.length > 0) {
                return proximoModulo.aulas[0];
            }
        }
        
        return null; // N√£o h√° pr√≥xima aula
    }

 async function enviarSolicitacaoParaAdm(aulaId, tipoSolicitacao = 'autorizacao_automatica', motivo = '') {
    console.log('üöÄ INICIANDO envio de solicita√ß√£o');
    
    try {
        const gerenciador = window.gerenciador;
        if (!gerenciador) {
            console.error('‚ùå Gerenciador n√£o dispon√≠vel');
            return false;
        }

        const aula = gerenciador.encontrarAula(aulaId);
        if (!aula) {
            console.error('‚ùå Aula n√£o encontrada:', aulaId);
            return false;
        }

        const payload = {
            usuarioId: parseInt(gerenciador.usuarioId) || 1,
            cursoId: parseInt(gerenciador.cursoId) || 1,
            aulaId: parseInt(aulaId),
            tipo: tipoSolicitacao === 'autorizacao_automatica' ? 'automatica' : 'manual',
            motivo: motivo || `Aluno ${gerenciador.usuarioId} completou aula anterior.`,
            automatica: tipoSolicitacao === 'autorizacao_automatica'
        };

        console.log('üì¶ Enviando payload:', payload);

        const response = await fetch(`${gerenciador.API_BASE}/solicitacoes`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        console.log('üì° Status:', response.status, response.statusText);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Erro do servidor:', errorText);
            
            console.log('üîÑ Tentando endpoint alternativo...');
            const altResponse = await fetch(`${gerenciador.API_BASE}/solicitacoes-autorizacao`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            if (altResponse.ok) {
                console.log('‚úÖ Sucesso no endpoint alternativo');
                return true;
            }
            
            return false;
        }

        const result = await response.json();
        console.log('‚úÖ Sucesso:', result);
        return true;

    } catch (error) {
        console.error('üí• Erro fatal:', error);
        return false;
    }
}

    function registrarSolicitacaoLocal(dadosSolicitacao) {
        try {
            // Armazenar solicita√ß√£o localmente para sincroniza√ß√£o posterior
            const solicitacoes = JSON.parse(localStorage.getItem('solicitacoes_pendentes') || '[]');
            solicitacoes.push({
                ...dadosSolicitacao,
                local: true,
                timestamp: new Date().getTime()
            });
            localStorage.setItem('solicitacoes_pendentes', JSON.stringify(solicitacoes));
            console.log('üìù Solicita√ß√£o registrada localmente para sincroniza√ß√£o posterior');
            return true;
        } catch (error) {
            console.error('Erro ao registrar solicita√ß√£o local:', error);
            return false;
        }
    }

    function mostrarNotificacaoSolicitacaoAutomatica(aula) {
        const notificacao = document.createElement('div');
        notificacao.className = 'notificacao-automatica';
        notificacao.style.cssText = `
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--info);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            text-align: center;
            animation: slideUp 0.5s ease;
        `;
        
        notificacao.innerHTML = `
            <i class="fas fa-robot"></i>
            <div>
                <strong>Solicita√ß√£o enviada automaticamente!</strong>
                <div style="font-size: 0.85rem; opacity: 0.9;">
                    Aguarde autoriza√ß√£o do administrador para: "${aula.titulo}"
                </div>
            </div>
        `;
        
        document.body.appendChild(notificacao);
        
        setTimeout(() => {
            if (notificacao.parentNode) {
                notificacao.style.animation = 'slideDown 0.5s ease forwards';
                setTimeout(() => notificacao.remove(), 500);
            }
        }, 5000);
    }

    // FUN√á√ïES GLOBAIS
    window.toggleModulo = function(index) {
        const modulo = document.getElementById(`modulo-${index}`);
        const aulasContainer = document.getElementById(`modulo-aulas-${index}`);
        
        if (!modulo || !aulasContainer) return;
        
        if (modulo.classList.contains('expanded')) {
            modulo.classList.remove('expanded');
            aulasContainer.style.maxHeight = '0';
        } else {
            modulo.classList.add('expanded');
            aulasContainer.style.maxHeight = aulasContainer.scrollHeight + 'px';
        }
    };

    window.iniciarAula = async function(aulaId) {
        try {
            console.log('Iniciando aula:', aulaId);
            
            const gerenciador = window.gerenciador;
            if (!gerenciador) {
                throw new Error('Sistema n√£o inicializado');
            }
            
            const conteudoElement = document.getElementById('aula-conteudo');
            if (conteudoElement) {
                conteudoElement.innerHTML = `
                    <div style="text-align:center; padding: 80px 20px;">
                        <div class="spinner"></div>
                        <h3 style="margin-top:25px; color:var(--primary);">Carregando conte√∫do da aula...</h3>
                        <p style="color:var(--gray);">Preparando a melhor experi√™ncia de aprendizado</p>
                    </div>
                `;
            }
            
            const modal = document.getElementById('aula-modal');
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            const conteudo = await gerenciador.carregarConteudoAula(aulaId);
            
            if (conteudoElement) {
                conteudoElement.innerHTML = conteudo;
            }
            
        } catch (error) {
            console.error('Erro ao iniciar aula:', error);
            const conteudoElement = document.getElementById('aula-conteudo');
            if (conteudoElement) {
                conteudoElement.innerHTML = `
                    <div style="text-align:center; padding: 50px 20px; color:var(--danger);">
                        <i class="fas fa-exclamation-triangle" style="font-size:3rem; margin-bottom:20px;"></i>
                        <h3>Erro ao iniciar a aula</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    };

    // MODAL DE SOLICITA√á√ÉO DE AUTORIZA√á√ÉO
    function mostrarModalSolicitacaoAutorizacao(aulaId) {
        const gerenciador = window.gerenciador;
        const aula = gerenciador.encontrarAula(aulaId);
        const cursoData = gerenciador.cursoData;
        
        if (!aula || !cursoData) return;
        
        // Fechar modal de aula atual se estiver aberto
        fecharAula();
        
        // Criar modal de solicita√ß√£o
        const modalHTML = `
            <div class="modal" id="solicitacao-modal">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-user-shield"></i> Solicitar Autoriza√ß√£o</h2>
                        <button class="modal-close" onclick="fecharModalSolicitacao()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; padding: 10px 0;">
                            <div style="font-size: 3rem; color: var(--warning); margin-bottom: 15px;">
                                <i class="fas fa-lock"></i>
                            </div>
                            <h3 style="color: var(--light); margin-bottom: 10px;">
                                Aula Bloqueada
                            </h3>
                            <p style="color: var(--gray); margin-bottom: 20px;">
                                Para acessar esta aula, voc√™ precisa de autoriza√ß√£o do administrador.
                            </p>
                            
                            <div style="background: rgba(255, 207, 0, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                                <h4 style="color: var(--primary); margin-bottom: 10px;">
                                    <i class="fas fa-graduation-cap"></i> ${aula.titulo}
                                </h4>
                                <div style="color: #ccc; font-size: 0.9rem;">
                                    <div><i class="fas fa-clock"></i> ${aula.duracao || '15'} minutos</div>
                                    ${aula.descricao ? `<div style="margin-top: 5px;">${aula.descricao}</div>` : ''}
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="color: var(--light); margin-bottom: 8px; display: block;">
                                    <i class="fas fa-comment"></i> Motivo da Solicita√ß√£o
                                </label>
                                <textarea id="motivo-solicitacao" 
                                          rows="4" 
                                          placeholder="Explique por que voc√™ precisa acessar esta aula..."
                                          style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid #555; color: white; padding: 12px; border-radius: 8px; font-family: inherit;"></textarea>
                            </div>
                            
                            <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: center;">
                                <button onclick="fecharModalSolicitacao()" 
                                        style="padding: 12px 24px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #555; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Cancelar
                                </button>
                                <button onclick="enviarSolicitacaoAutorizacaoManual(${aulaId})" 
                                        style="padding: 12px 24px; background: var(--warning); color: black; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-paper-plane"></i> Enviar Solicita√ß√£o
                                </button>
                            </div>
                            
                            <div style="margin-top: 20px; color: #888; font-size: 0.85rem; text-align: center;">
                                <i class="fas fa-info-circle"></i> O administrador ser√° notificado e voc√™ receber√° uma resposta em breve.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Adicionar modal ao documento
        if (!document.getElementById('solicitacao-modal')) {
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Mostrar modal
        document.getElementById('solicitacao-modal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
// ‚úÖ FUN√á√ÉO CORRIGIDA PARA ENVIAR SOLICITA√á√ÉO AUTOM√ÅTICA
async function enviarSolicitacaoAutomaticaParaProximaAula(aulaConcluidaId, proximaAulaId, motivo) {
    console.log('üöÄ Enviando solicita√ß√£o autom√°tica para pr√≥xima aula');
    
    try {
        const gerenciador = window.gerenciador;
        if (!gerenciador) {
            console.error('‚ùå Gerenciador n√£o dispon√≠vel');
            return false;
        }

        const aulaConcluida = gerenciador.encontrarAula(aulaConcluidaId);
        const proximaAula = gerenciador.encontrarAula(proximaAulaId);
        
        if (!aulaConcluida || !proximaAula) {
            console.error('‚ùå Aulas n√£o encontradas');
            return false;
        }

        const payload = {
            usuarioId: parseInt(gerenciador.usuarioId) || 1,
            cursoId: parseInt(gerenciador.cursoId) || 1,
            aulaConcluidaId: parseInt(aulaConcluidaId),
            aulaId: parseInt(proximaAulaId), // ‚Üê PR√ìXIMA aula, n√£o a atual
            motivo: motivo || `Aluno completou "${aulaConcluida.titulo}" e aguarda autoriza√ß√£o para "${proximaAula.titulo}".`,
            tipo: 'automatica',
            automatica: true
        };

        console.log('üì¶ Payload para solicita√ß√£o autom√°tica:', payload);

        // Tentar endpoint principal primeiro
        let response = await fetch(`${gerenciador.API_BASE}/solicitacoes/automatica`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        console.log('üì° Status do endpoint /automatica:', response.status);

        // Se endpoint autom√°tico falhar, tentar endpoint geral
        if (!response.ok) {
            console.log('üîÑ Tentando endpoint geral de solicita√ß√µes...');
            
            response = await fetch(`${gerenciador.API_BASE}/solicitacoes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    usuarioId: payload.usuarioId,
                    cursoId: payload.cursoId,
                    aulaId: payload.aulaId,
                    tipo: 'automatica',
                    automatica: true,
                    motivo: payload.motivo
                })
            });
        }

        console.log('üì° Status final:', response.status, response.statusText);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Erro do servidor:', errorText);
            return false;
        }

        const result = await response.json();
        console.log('‚úÖ Solicita√ß√£o enviada com sucesso:', result);
        return true;

    } catch (error) {
        console.error('üí• Erro fatal ao enviar solicita√ß√£o:', error);
        return false;
    }
}

function mostrarNotificacaoSolicitacaoEnviada(proximaAula) {
    const notificacaoAnterior = document.querySelector('.notificacao-solicitacao-enviada');
    if (notificacaoAnterior) {
        notificacaoAnterior.remove();
    }

    const notificacao = document.createElement('div');
    notificacao.className = 'notificacao-solicitacao-enviada';
    notificacao.style.cssText = `
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: var(--info);
        color: white;
        padding: 15px 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        z-index: 1001;
        display: flex;
        align-items: center;
        gap: 12px;
        max-width: 400px;
        animation: slideInRight 0.5s ease;
    `;
    
    notificacao.innerHTML = `
        <i class="fas fa-paper-plane"></i>
        <div>
            <strong>Solicita√ß√£o Enviada!</strong>
            <div style="font-size: 0.85rem; opacity: 0.9;">
                Pr√≥xima aula: "${proximaAula.titulo}"<br>
                Aguarde autoriza√ß√£o do administrador.
            </div>
        </div>
    `;
    
    document.body.appendChild(notificacao);
    
    setTimeout(() => {
        if (notificacao.parentNode) {
            notificacao.style.animation = 'fadeOut 0.5s ease forwards';
            setTimeout(() => notificacao.remove(), 500);
        }
    }, 5000);
}
    // FUN√á√ÉO PARA ENVIAR SOLICITA√á√ÉO DE AUTORIZA√á√ÉO MANUAL
    async function enviarSolicitacaoAutorizacaoManual(aulaId) {
        const gerenciador = window.gerenciador;
        const motivo = document.getElementById('motivo-solicitacao')?.value.trim() || 
                       `Solicita√ß√£o manual do aluno para acessar a aula.`;
        
        try {
            showGlobalLoading(true);
            
            // Enviar solicita√ß√£o manual
            const enviada = await enviarSolicitacaoParaAdm(aulaId, 'autorizacao_manual', motivo);
            
            if (enviada) {
                mostrarNotificacaoSolicitacaoEnviada();
                fecharModalSolicitacao();
            } else {
                throw new Error('N√£o foi poss√≠vel enviar a solicita√ß√£o');
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao enviar solicita√ß√£o:', error);
            alert('‚ùå Erro ao enviar solicita√ß√£o. Tente novamente.');
        } finally {
            showGlobalLoading(false);
        }
    }

 window.marcarAulaConcluida = async function() {
    try {
        if (!aulaAtualId) {
            console.error('Nenhuma aula selecionada');
            return;
        }
        
        const gerenciador = window.gerenciador;
        if (!gerenciador) {
            console.error('Gerenciador n√£o inicializado');
            return;
        }
        
        // Verificar se j√° est√° conclu√≠da
        if (gerenciador.aulasConcluidas.includes(aulaAtualId)) {
            console.log('Aula j√° est√° conclu√≠da');
            return;
        }
        
        const aula = gerenciador.encontrarAula(aulaAtualId);
        const isPrimeiraAula = aula && aula.aulaIndex === 0;
        
        if (!isPrimeiraAula) {
            const autorizada = gerenciador.verificarAulaAutorizada(aulaAtualId);
            
            if (!autorizada) {
                console.log('‚ùå Aula n√£o autorizada!');
                mostrarModalSolicitacaoAutorizacao(aulaAtualId);
                return;
            }
        }
        
        // Marcar aula como conclu√≠da
        const concluida = gerenciador.marcarAulaConcluida(aulaAtualId);
        
        if (concluida) {
            aulaAtualConcluida = true;
            console.log(`‚úÖ Aula ${aulaAtualId} marcada como conclu√≠da`);
            
            // ‚úÖ CORRE√á√ÉO AQUI: Encontrar pr√≥xima aula e enviar solicita√ß√£o
            const proximaAula = encontrarProximaAula(aulaAtualId);
            
            if (proximaAula) {
                console.log(`üì§ Enviando solicita√ß√£o para pr√≥xima aula: ${proximaAula.id}`);
                
                // Enviar solicita√ß√£o autom√°tica para a PR√ìXIMA aula
                const solicitacaoEnviada = await enviarSolicitacaoAutomaticaParaProximaAula(
                    aulaAtualId, 
                    proximaAula.id,
                    `Aluno completou "${aula?.titulo || 'aula anterior'}" e est√° pronto para continuar.`
                );
                
                if (solicitacaoEnviada) {
                    mostrarNotificacaoSolicitacaoEnviada(proximaAula);
                }
            } else {
                console.log('‚ÑπÔ∏è N√£o h√° pr√≥xima aula dispon√≠vel');
            }
            
            // Atualizar UI
            const btnConcluir = document.getElementById('btn-concluir-aula');
            if (btnConcluir) {
                btnConcluir.innerHTML = '<i class="fas fa-check-double"></i> <span>Aula Conclu√≠da</span>';
                btnConcluir.classList.add('concluida');
                btnConcluir.disabled = true;
            }
            
            const estadoElement = document.getElementById('aula-estado');
            if (estadoElement) {
                estadoElement.textContent = 'Conclu√≠da';
                estadoElement.style.color = 'var(--success)';
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao marcar aula como conclu√≠da:', error);
        alert('‚ùå Erro ao salvar progresso. Tente novamente.');
    }
};
    
    window.fecharAula = function() {
        const modal = document.getElementById('aula-modal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    };

    // FECHAR MODAL COM ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            fecharAula();
            fecharModalSolicitacao();
        }
    });

    // FECHAR MODAL AO CLICAR FORA
    document.addEventListener('click', function(e) {
        const modalAula = document.getElementById('aula-modal');
        const modalSolicitacao = document.getElementById('solicitacao-modal');
        
        if (modalAula && e.target === modalAula) {
            fecharAula();
        }
        
        if (modalSolicitacao && e.target === modalSolicitacao) {
            fecharModalSolicitacao();
        }
    });

    // INICIALIZAR
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM carregado - Iniciando Gerenciador de Cursos');
        window.gerenciador = new GerenciadorCursos();
        window.gerenciador.carregarCurso();
    });
</script>
</body>
</html>








