<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso - Coliseum</title>
    <style>
        body {
            background: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        h1 { color: #ffcf00; }
        .btn-voltar {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #2a2a2a;
            color: #ffcf00;
            border: 2px solid #ffcf00;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
        }
        .modulo {
            background: #2a2a2a;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .modulo-header {
            padding: 20px;
            background: #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }
        .aula-item {
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            cursor: pointer;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #ffcf00;
        }
    </style>
</head>
<body>
    <button class="btn-voltar" onclick="voltarParaCursos()">←</button>
    
    <div class="container">
        <div class="header">
            <h1 id="curso-titulo">Carregando...</h1>
            <p id="curso-descricao"></p>
        </div>
        
        <div id="modulos-container">
            <div class="loading">
                <div style="
                    width: 50px;
                    height: 50px;
                    border: 5px solid rgba(255, 207, 0, 0.3);
                    border-top-color: #ffcf00;
                    border-radius: 50%;
                    margin: 0 auto 20px;
                    animation: spin 1s linear infinite;
                "></div>
                <h3>Carregando conteúdo do curso...</h3>
            </div>
        </div>
    </div>

    <script>
        // FUNÇÃO VOLTAR - DEFINIDA PRIMEIRO!
        function voltarParaCursos() {
            console.log('Voltando para cursos...');
            const urlParams = new URLSearchParams(window.location.search);
            const from = urlParams.get('from');
            
            if (from === 'extras') {
                window.location.href = '/CursosExtras/indexEX.html';
            } else {
                window.history.back();
            }
        }

        // GERENCIADOR
        class GerenciadorCursos {
            constructor() {
                this.API_BASE = 'https://coliseum-api.onrender.com/api';
                this.usuarioId = this.obterUsuarioId();
                console.log('Usuário:', this.usuarioId);
            }

            obterUsuarioId() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const usuarioId = urlParams.get('usuarioId');
                    
                    if (usuarioId) {
                        localStorage.setItem('usuarioId', usuarioId);
                        return usuarioId;
                    }
                    
                    return localStorage.getItem('usuarioId') || '1';
                } catch (e) {
                    console.error('Erro:', e);
                    return '1';
                }
            }

            async carregarCurso() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const cursoId = urlParams.get('id');
                    
                    if (!cursoId) {
                        this.mostrarErro('Curso não especificado');
                        return;
                    }

                    console.log('Buscando curso', cursoId);
                    
                    const response = await fetch(`${this.API_BASE}/cursos/${cursoId}?usuarioId=${this.usuarioId}`);
                    
                    if (!response.ok) {
                        throw new Error('Erro ao carregar curso');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.curso) {
                        this.exibirCurso(data.curso);
                        await this.carregarModulos(cursoId);
                    } else {
                        throw new Error(data.error || 'Erro desconhecido');
                    }
                    
                } catch (error) {
                    console.error('Erro:', error);
                    this.mostrarErro(error.message);
                }
            }

            async carregarModulos(cursoId) {
                try {
                    const response = await fetch(`${this.API_BASE}/cursos/${cursoId}/modulos?usuarioId=${this.usuarioId}`);
                    
                    if (!response.ok) {
                        throw new Error('Erro ao carregar módulos');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.exibirModulos(data.modulos || []);
                    }
                    
                } catch (error) {
                    console.error('Erro módulos:', error);
                }
            }

            exibirCurso(curso) {
                document.getElementById('curso-titulo').textContent = curso.titulo;
                document.getElementById('curso-descricao').textContent = curso.descricao || '';
                document.title = `${curso.titulo} - Coliseum`;
            }

            exibirModulos(modulos) {
                const container = document.getElementById('modulos-container');
                
                if (modulos.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:50px;color:#888">Nenhum módulo encontrado</div>';
                    return;
                }
                
                let html = '';
                
                modulos.forEach((modulo, index) => {
                    html += `
                        <div class="modulo">
                            <div class="modulo-header" onclick="toggleModulo(${index})">
                                <h3>${this.escapeHtml(modulo.titulo)}</h3>
                                <span>${modulo.aulas?.length || 0} aulas</span>
                            </div>
                            <div id="modulo-${index}" style="display:none">
                                ${this.gerarAulas(modulo.aulas || [])}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }

            gerarAulas(aulas) {
                if (aulas.length === 0) {
                    return '<div style="padding:20px;color:#888">Nenhuma aula</div>';
                }
                
                return aulas.map(aula => `
                    <div class="aula-item" onclick="iniciarAula(${aula.id})">
                        <strong>${this.escapeHtml(aula.titulo)}</strong>
                        <br>
                        <small>${aula.duracao || '10:00'} min</small>
                    </div>
                `).join('');
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            mostrarErro(mensagem) {
                const container = document.getElementById('modulos-container');
                container.innerHTML = `
                    <div style="background:#f44336;color:white;padding:20px;border-radius:10px;text-align:center">
                        <h3>Erro</h3>
                        <p>${this.escapeHtml(mensagem)}</p>
                        <button onclick="location.reload()" style="margin:10px;padding:10px 20px;background:white;border:none;border-radius:5px;cursor:pointer">
                            Tentar Novamente
                        </button>
                        <button onclick="voltarParaCursos()" style="margin:10px;padding:10px 20px;background:#ffcf00;border:none;border-radius:5px;cursor:pointer">
                            Voltar
                        </button>
                    </div>
                `;
            }
        }

        // FUNÇÕES GLOBAIS
        window.toggleModulo = function(index) {
            const el = document.getElementById(`modulo-${index}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        };

        window.iniciarAula = function(aulaId) {
            alert(`Aula ${aulaId} iniciada!`);
        };

        // INICIALIZAR
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado');
            window.gerenciador = new GerenciadorCursos();
            window.gerenciador.carregarCurso();
        });
    </script>
</body>
</html>
