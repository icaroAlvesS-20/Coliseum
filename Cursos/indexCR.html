<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso - Coliseum</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* RESET E VARI√ÅVEIS */
        :root {
            --primary: #ffcf00;
            --primary-dark: #e6b800;
            --secondary: #4361ee;
            --dark: #1a1a1a;
            --dark-light: #2a2a2a;
            --dark-lighter: #333333;
            --light: #ffffff;
            --gray: #888888;
            --success: #4CAF50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196F3;
            
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s ease;
            --gradient-primary: linear-gradient(135deg, #ffcf00 0%, #ff6b00 100%);
            --gradient-dark: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--dark);
            color: var(--light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* BOT√ÉO VOLTAR */
        .btn-voltar {
            position: fixed;
            top: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
            background: var(--dark-light);
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .btn-voltar:hover {
            background: var(--primary);
            color: var(--dark);
            transform: translateX(-5px);
            box-shadow: 0 6px 25px rgba(255, 207, 0, 0.4);
        }

        /* CONTAINER PRINCIPAL */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 30px;
            animation: fadeIn 0.8s ease;
        }

        /* HEADER DO CURSO */
        .curso-header {
            background: var(--gradient-dark);
            border-radius: var(--border-radius-lg);
            padding: 40px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 207, 0, 0.1);
        }

        .curso-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .curso-header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .curso-meta {
            display: flex;
            gap: 25px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--gray);
            font-size: 0.95rem;
        }

        .meta-item i {
            color: var(--primary);
            font-size: 1.1rem;
        }

        /* M√ìDULOS */
        .modulos-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .modulo {
            background: var(--dark-light);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
        }

        .modulo:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(255, 207, 0, 0.2);
        }

        .modulo-header {
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
        }

        .modulo-header:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        .modulo-header h3 {
            color: var(--light);
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modulo-header h3::before {
            content: 'üìö';
            font-size: 1.2rem;
        }

        .modulo-contador {
            background: var(--primary);
            color: var(--dark);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* AULAS */
        .aulas-container {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease, padding 0.3s ease;
        }

        .modulo.expanded .aulas-container {
            padding: 20px;
            max-height: 1000px;
        }

        .aula-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 4px solid transparent;
            position: relative;
        }

        .aula-item:last-child {
            margin-bottom: 0;
        }

        .aula-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
            border-left-color: var(--primary);
        }

        .aula-item.completa {
            background: rgba(76, 175, 80, 0.1);
            border-left-color: var(--success);
        }

        .aula-icone {
            width: 40px;
            height: 40px;
            background: rgba(255, 207, 0, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .aula-item.completa .aula-icone {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .aula-info {
            flex: 1;
        }

        .aula-info h4 {
            color: var(--light);
            font-size: 1.1rem;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .aula-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: var(--gray);
        }

        .aula-status {
            margin-left: auto;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.05);
        }

        .aula-item.completa .aula-status {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 80px 20px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 207, 0, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 0 auto 25px;
            animation: spin 1s linear infinite;
        }

        .loading h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .loading p {
            color: var(--gray);
        }

        /* MODAL DE AULA */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--dark-light);
            margin: 30px auto;
            padding: 0;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: var(--gradient-dark);
            padding: 25px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 30px;
            right: 30px;
            height: 2px;
            background: var(--gradient-primary);
        }

        .modal-header h2 {
            color: var(--primary);
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0;
            flex: 1;
            padding-right: 20px;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--light);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: var(--danger);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        /* VIDEO CONTAINER */
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* CONTE√öDO DA AULA */
        .conteudo-aula {
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .conteudo-aula h3 {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 207, 0, 0.2);
        }

        .conteudo-aula p, .conteudo-aula li {
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        .conteudo-aula ul, .conteudo-aula ol {
            padding-left: 20px;
            margin-bottom: 20px;
        }

        .conteudo-aula code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--primary);
        }

        /* PROGRESSO */
        .progresso-bar {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--dark-light);
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 207, 0, 0.2);
            z-index: 100;
            animation: slideInRight 0.5s ease;
        }

        .progresso-bar h4 {
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progresso-container {
            width: 200px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progresso-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s ease;
        }

        /* ANIMA√á√ïES */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 207, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 207, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 207, 0, 0); }
        }

        /* RESPONSIVO */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }

            .curso-header {
                padding: 25px 20px;
            }

            .curso-header h1 {
                font-size: 1.8rem;
            }

            .curso-meta {
                gap: 15px;
            }

            .modulo-header {
                padding: 20px;
            }

            .modulo-header h3 {
                font-size: 1.1rem;
            }

            .aula-item {
                padding: 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .aula-status {
                align-self: flex-start;
                margin-left: 0;
            }

            .btn-voltar {
                top: 15px;
                left: 15px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .modal-content {
                margin: 10px auto;
                width: 98%;
                max-height: 95vh;
            }

            .modal-header {
                padding: 20px;
            }

            .modal-header h2 {
                font-size: 1.4rem;
            }

            .modal-body {
                padding: 20px;
            }

            .progresso-bar {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
            }

            .progresso-container {
                width: 150px;
            }
        }

        @media (max-width: 480px) {
            .curso-header h1 {
                font-size: 1.5rem;
            }

            .meta-item {
                font-size: 0.85rem;
            }

            .modal-header h2 {
                font-size: 1.2rem;
            }

            .progresso-bar {
                bottom: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
            }
        }

        /* ESTADO VAZIO */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--primary);
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--light);
        }

        /* SCROLLBAR PERSONALIZADA */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <!-- Bot√£o Voltar -->
    <button class="btn-voltar" onclick="voltarParaCursos()" title="Voltar para Cursos">
        <i class="fas fa-arrow-left"></i>
    </button>
    
    <!-- Progresso Fixo -->
    <div class="progresso-bar" id="progresso-bar">
        <h4>Progresso do Curso</h4>
        <div class="progresso-container">
            <div class="progresso-fill" id="progresso-fill"></div>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="container">
        <!-- Header do Curso -->
        <div class="curso-header">
            <h1 id="curso-titulo">Carregando...</h1>
            <p id="curso-descricao"></p>
            <div class="curso-meta" id="curso-meta">
                <!-- Metadados ser√£o preenchidos via JS -->
            </div>
        </div>
        
        <!-- M√≥dulos -->
        <div id="modulos-container">
            <div class="loading">
                <div class="spinner"></div>
                <h3>Carregando conte√∫do do curso...</h3>
                <p>Preparando sua experi√™ncia de aprendizado</p>
            </div>
        </div>
    </div>

    <!-- Modal de Aula -->
    <div class="modal" id="aula-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="aula-titulo"></h2>
                <button class="modal-close" onclick="fecharAula()" title="Fechar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="aula-conteudo">
                <!-- Conte√∫do ser√° carregado aqui -->
            </div>
        </div>
    </div>

    <script>
        // FUN√á√ÉO VOLTAR
        function voltarParaCursos() {
            console.log('Voltando para cursos...');
            const urlParams = new URLSearchParams(window.location.search);
            const from = urlParams.get('from');
            
            if (from === 'extras') {
                window.location.href = '/CursosExtras/indexEX.html';
            } else {
                window.history.back();
            }
        }

        // GERENCIADOR PRINCIPAL
        class GerenciadorCursos {
            constructor() {
                this.API_BASE = 'https://coliseum-api.onrender.com/api';
                this.usuarioId = this.obterUsuarioId();
                this.cursoId = this.obterCursoId();
                this.aulasConcluidas = this.carregarProgresso();
                this.totalAulas = 0;
                this.aulasCarregadas = 0;
                this.cursoData = null;
                this.aulasMap = new Map(); // Mapa para r√°pido acesso √†s aulas
            }

            obterUsuarioId() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const usuarioId = urlParams.get('usuarioId');
                    
                    if (usuarioId) {
                        localStorage.setItem('usuarioId', usuarioId);
                        return usuarioId;
                    }
                    
                    return localStorage.getItem('usuarioId') || '1';
                } catch (e) {
                    console.error('Erro:', e);
                    return '1';
                }
            }

            obterCursoId() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            }

            carregarProgresso() {
                const progresso = localStorage.getItem(`progresso_${this.usuarioId}_${this.cursoId}`);
                return progresso ? JSON.parse(progresso) : [];
            }

            salvarProgresso(aulaId) {
                if (!this.aulasConcluidas.includes(aulaId)) {
                    this.aulasConcluidas.push(aulaId);
                    localStorage.setItem(`progresso_${this.usuarioId}_${this.cursoId}`, 
                                        JSON.stringify(this.aulasConcluidas));
                    this.atualizarProgressoBar();
                }
            }

            calcularProgresso() {
                if (this.totalAulas === 0) return 0;
                return Math.round((this.aulasConcluidas.length / this.totalAulas) * 100);
            }

            atualizarProgressoBar() {
                const progresso = this.calcularProgresso();
                const progressoFill = document.getElementById('progresso-fill');
                if (progressoFill) {
                    progressoFill.style.width = `${progresso}%`;
                }
            }

            async carregarCurso() {
                try {
                    if (!this.cursoId) {
                        this.mostrarErro('Curso n√£o especificado');
                        return;
                    }

                    console.log('Buscando curso completo:', this.cursoId);
                    
                    // Buscar o curso COMPLETO com todos os m√≥dulos e aulas
                    const response = await fetch(`${this.API_BASE}/cursos/${this.cursoId}?usuarioId=${this.usuarioId}`);
                    
                    if (!response.ok) {
                        throw new Error(`Erro ${response.status} ao carregar curso`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.curso) {
                        this.cursoData = data.curso;
                        this.exibirCurso(data.curso);
                        this.processarAulas(data.curso.modulos || []);
                    } else {
                        throw new Error(data.error || 'Erro desconhecido');
                    }
                    
                } catch (error) {
                    console.error('Erro ao carregar curso:', error);
                    this.mostrarErro(error.message);
                }
            }

            processarAulas(modulos) {
                console.log('Processando m√≥dulos:', modulos);
                
                // Criar mapa de aulas para acesso r√°pido
                this.aulasMap.clear();
                this.totalAulas = 0;
                
                modulos.forEach((modulo, moduloIndex) => {
                    if (modulo.aulas && Array.isArray(modulo.aulas)) {
                        modulo.aulas.forEach((aula, aulaIndex) => {
                            if (aula && aula.id) {
                                // Adicionar refer√™ncias para f√°cil acesso
                                aula.moduloIndex = moduloIndex;
                                aula.aulaIndex = aulaIndex;
                                this.aulasMap.set(aula.id, aula);
                                this.totalAulas++;
                            }
                        });
                    }
                });
                
                console.log(`Total de aulas mapeadas: ${this.aulasMap.size}`);
                this.exibirModulosComAulas(modulos);
                this.atualizarProgressoBar();
            }

            encontrarAula(aulaId) {
                // Procurar aula no mapa
                if (this.aulasMap.has(aulaId)) {
                    return this.aulasMap.get(aulaId);
                }
                
                // Se n√£o encontrar, procurar nos m√≥dulos do curso
                if (this.cursoData && this.cursoData.modulos) {
                    for (const modulo of this.cursoData.modulos) {
                        if (modulo.aulas) {
                            const aula = modulo.aulas.find(a => a.id == aulaId);
                            if (aula) return aula;
                        }
                    }
                }
                
                return null;
            }

            exibirCurso(curso) {
                const tituloElement = document.getElementById('curso-titulo');
                const descricaoElement = document.getElementById('curso-descricao');
                const metaContainer = document.getElementById('curso-meta');
                
                if (tituloElement) {
                    tituloElement.textContent = curso.titulo || 'Curso Sem T√≠tulo';
                }
                
                if (descricaoElement) {
                    descricaoElement.textContent = curso.descricao || '';
                }
                
                document.title = `${curso.titulo || 'Curso'} - Coliseum`;

                // Atualizar metadados
                if (metaContainer) {
                    // Calcular total de aulas
                    const totalAulas = curso.modulos ? 
                        curso.modulos.reduce((total, modulo) => total + (modulo.aulas?.length || 0), 0) : 0;
                    
                    metaContainer.innerHTML = `
                        <div class="meta-item">
                            <i class="fas fa-clock"></i>
                            <span>${curso.duracao || '--'} horas</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-layer-group"></i>
                            <span>${curso.modulos?.length || 0} m√≥dulos</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-book"></i>
                            <span>${totalAulas} aulas</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-graduation-cap"></i>
                            <span>${curso.nivel || 'Todos os n√≠veis'}</span>
                        </div>
                    `;
                }
            }

            exibirModulosComAulas(modulos) {
                const container = document.getElementById('modulos-container');
                
                if (!container) {
                    console.error('Container de m√≥dulos n√£o encontrado!');
                    return;
                }
                
                if (!modulos || modulos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-graduation-cap"></i>
                            <h3>Nenhum m√≥dulo encontrado</h3>
                            <p>Este curso ainda n√£o possui conte√∫do dispon√≠vel.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                modulos.forEach((modulo, index) => {
                    const aulasCount = modulo.aulas?.length || 0;
                    
                    html += `
                        <div class="modulo" id="modulo-${index}">
                            <div class="modulo-header" onclick="toggleModulo(${index})">
                                <h3>${this.escapeHtml(modulo.titulo || `M√≥dulo ${index + 1}`)}</h3>
                                <span class="modulo-contador">${aulasCount} aula${aulasCount !== 1 ? 's' : ''}</span>
                            </div>
                            <div class="aulas-container" id="modulo-aulas-${index}">
                                ${this.gerarListaAulas(modulo.aulas || [])}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }

            gerarListaAulas(aulas) {
                if (!aulas || aulas.length === 0) {
                    return '<div style="padding:20px;color:#888;text-align:center;">Nenhuma aula dispon√≠vel neste m√≥dulo</div>';
                }

                return aulas.map(aula => {
                    if (!aula || !aula.id) {
                        return '';
                    }
                    
                    const concluida = this.aulasConcluidas.includes(aula.id);
                    const aulaIcon = aula.videoUrl ? 'fas fa-play-circle' : 'fas fa-book';
                    
                    return `
                        <div class="aula-item ${concluida ? 'completa' : ''}" 
                             onclick="iniciarAula(${aula.id})"
                             data-aula-id="${aula.id}">
                            <div class="aula-icone">
                                <i class="${aulaIcon}"></i>
                            </div>
                            <div class="aula-info">
                                <h4>${this.escapeHtml(aula.titulo || `Aula ${aula.id}`)}</h4>
                                <div class="aula-meta">
                                    <span><i class="fas fa-clock"></i> ${aula.duracao || '10:00'} min</span>
                                    ${aula.nivel ? `<span><i class="fas fa-chart-bar"></i> ${aula.nivel}</span>` : ''}
                                </div>
                            </div>
                            <div class="aula-status">
                                ${concluida ? '<i class="fas fa-check"></i> Conclu√≠da' : 'Pendente'}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async carregarConteudoAula(aulaId) {
                try {
                    console.log('Carregando conte√∫do da aula:', aulaId);
                    
                    // Primeiro, tentar encontrar a aula nos dados j√° carregados
                    let aula = this.encontrarAula(aulaId);
                    
                    if (!aula) {
                        console.log('Aula n√£o encontrada no cache, tentando buscar da API...');
                        
                        // Tentar buscar espec√≠fico da aula (se a API suportar)
                        try {
                            const response = await fetch(`${this.API_BASE}/cursos/${this.cursoId}/aulas/${aulaId}?usuarioId=${this.usuarioId}`);
                            if (response.ok) {
                                const data = await response.json();
                                if (data.success && data.aula) {
                                    aula = data.aula;
                                }
                            }
                        } catch (apiError) {
                            console.log('API de aula espec√≠fica n√£o dispon√≠vel, usando dados do curso');
                        }
                    }
                    
                    if (!aula) {
                        throw new Error('Aula n√£o encontrada');
                    }
                    
                    return this.formatarConteudoAula(aula);
                    
                } catch (error) {
                    console.error('Erro ao carregar conte√∫do:', error);
                    return this.conteudoErro(error);
                }
            }

            extrairYouTubeId(url) {
                if (!url) return null;
                
                // Padr√µes de URLs do YouTube
                const patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
                    /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/,
                    /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/
                ];
                
                for (const pattern of patterns) {
                    const match = url.match(pattern);
                    if (match && match[1]) {
                        return match[1];
                    }
                }
                
                return null;
            }

            formatarConteudoAula(aula) {
                let conteudo = '';
                
                // Atualizar t√≠tulo no modal
                const tituloElement = document.getElementById('aula-titulo');
                if (tituloElement) {
                    tituloElement.textContent = aula.titulo || `Aula ${aula.id}`;
                }
                
                // Verificar se tem v√≠deo do YouTube
                if (aula.videoUrl) {
                    const videoId = this.extrairYouTubeId(aula.videoUrl);
                    
                    if (videoId) {
                        // URL segura para embed do YouTube
                        const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                        
                        conteudo += `
                            <div class="video-container">
                                <iframe src="${embedUrl}" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen
                                        loading="lazy">
                                </iframe>
                            </div>
                        `;
                    } else {
                        // Se n√£o for um v√≠deo do YouTube v√°lido, mostrar link
                        conteudo += `
                            <div class="conteudo-aula">
                                <h3><i class="fas fa-video"></i> Conte√∫do de V√≠deo</h3>
                                <p>Link do v√≠deo: <a href="${this.escapeHtml(aula.videoUrl)}" target="_blank" style="color:var(--primary);">${this.escapeHtml(aula.videoUrl)}</a></p>
                                <small style="color:var(--gray);">Clique no link para assistir em outra aba</small>
                            </div>
                        `;
                    }
                }
                
                // Se tiver conte√∫do textual
                if (aula.conteudo) {
                    conteudo += `
                        <div class="conteudo-aula">
                            <h3><i class="fas fa-file-alt"></i> Conte√∫do da Aula</h3>
                            <div>${this.formatarTexto(aula.conteudo)}</div>
                        </div>
                    `;
                } else if (aula.descricao) {
                    // Se n√£o tiver conte√∫do mas tiver descri√ß√£o
                    conteudo += `
                        <div class="conteudo-aula">
                            <h3><i class="fas fa-info-circle"></i> Descri√ß√£o</h3>
                            <p>${this.escapeHtml(aula.descricao)}</p>
                        </div>
                    `;
                }
                
                // Se n√£o tiver conte√∫do espec√≠fico
                if (!conteudo) {
                    conteudo = this.conteudoPadrao(aula);
                }
                
                return conteudo;
            }

            conteudoPadrao(aula) {
                return `
                    <div class="empty-state">
                        <i class="fas fa-graduation-cap"></i>
                        <h3>${this.escapeHtml(aula.titulo || `Aula ${aula.id}`)}</h3>
                        <p>Esta aula est√° sendo preparada com o melhor conte√∫do para voc√™.</p>
                        ${aula.videoUrl ? `
                            <div style="margin-top: 20px;">
                                <a href="${this.escapeHtml(aula.videoUrl)}" target="_blank" 
                                   style="display:inline-flex; align-items:center; gap:10px; 
                                          padding:12px 24px; background:var(--primary); 
                                          color:var(--dark); border-radius:var(--border-radius-sm);
                                          text-decoration:none; font-weight:600;">
                                    <i class="fas fa-external-link-alt"></i>
                                    Assistir V√≠deo Externo
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            conteudoErro(error) {
                return `
                    <div style="text-align:center; padding: 50px;">
                        <div style="font-size:4rem; color:var(--danger); margin-bottom:20px;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 style="color:var(--light); margin-bottom:15px;">Erro ao Carregar Conte√∫do</h3>
                        <p style="color:var(--gray); margin-bottom:10px;">${this.escapeHtml(error.message)}</p>
                        <p style="color:var(--gray); font-size:0.9rem;">ID da Aula n√£o encontrado ou conte√∫do indispon√≠vel</p>
                        <button onclick="location.reload()" style="
                            margin-top:20px; 
                            padding:12px 24px; 
                            background:var(--primary); 
                            color:var(--dark); 
                            border:none; 
                            border-radius:var(--border-radius-sm);
                            cursor:pointer;
                            font-weight:600;
                        ">
                            <i class="fas fa-redo"></i> Recarregar P√°gina
                        </button>
                    </div>
                `;
            }

            formatarTexto(texto) {
                if (!texto) return '';
                
                return this.escapeHtml(texto)
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/```(.*?)```/gs, '<pre style="background:rgba(0,0,0,0.3);padding:15px;border-radius:8px;overflow:auto;"><code>$1</code></pre>')
                    .replace(/`(.*?)`/g, '<code style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;">$1</code>');
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            mostrarErro(mensagem) {
                const container = document.getElementById('modulos-container');
                if (!container) return;
                
                container.innerHTML = `
                    <div style="background:rgba(244,67,54,0.1); border:1px solid rgba(244,67,54,0.3); border-radius:var(--border-radius); padding:30px; text-align:center;">
                        <div style="font-size:3rem; color:var(--danger); margin-bottom:20px;">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <h3 style="color:var(--light); margin-bottom:15px;">Erro ao Carregar Curso</h3>
                        <p style="color:var(--gray); margin-bottom:25px;">${this.escapeHtml(mensagem)}</p>
                        <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                            <button onclick="location.reload()" style="
                                padding:12px 24px; 
                                background:var(--primary); 
                                color:var(--dark); 
                                border:none; 
                                border-radius:var(--border-radius-sm);
                                cursor:pointer;
                                font-weight:600;
                                display:flex;
                                align-items:center;
                                gap:8px;
                            ">
                                <i class="fas fa-redo"></i> Tentar Novamente
                            </button>
                            <button onclick="voltarParaCursos()" style="
                                padding:12px 24px; 
                                background:var(--dark-lighter); 
                                color:var(--light); 
                                border:1px solid rgba(255,255,255,0.1); 
                                border-radius:var(--border-radius-sm);
                                cursor:pointer;
                                font-weight:600;
                                display:flex;
                                align-items:center;
                                gap:8px;
                            ">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // FUN√á√ïES GLOBAIS
        window.toggleModulo = function(index) {
            const modulo = document.getElementById(`modulo-${index}`);
            const aulasContainer = document.getElementById(`modulo-aulas-${index}`);
            
            if (!modulo || !aulasContainer) return;
            
            if (modulo.classList.contains('expanded')) {
                modulo.classList.remove('expanded');
                aulasContainer.style.maxHeight = '0';
            } else {
                modulo.classList.add('expanded');
                aulasContainer.style.maxHeight = aulasContainer.scrollHeight + 'px';
            }
        };

        window.iniciarAula = async function(aulaId) {
            try {
                console.log('Iniciando aula:', aulaId);
                
                const gerenciador = window.gerenciador;
                if (!gerenciador) {
                    throw new Error('Sistema n√£o inicializado');
                }
                
                // Mostrar loading no modal
                const conteudoElement = document.getElementById('aula-conteudo');
                if (conteudoElement) {
                    conteudoElement.innerHTML = `
                        <div style="text-align:center; padding: 80px 20px;">
                            <div class="spinner"></div>
                            <h3 style="margin-top:25px; color:var(--primary);">Carregando conte√∫do da aula...</h3>
                            <p style="color:var(--gray);">Preparando a melhor experi√™ncia de aprendizado</p>
                        </div>
                    `;
                }
                
                // Abrir modal
                const modal = document.getElementById('aula-modal');
                if (modal) {
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                }
                
                // Carregar conte√∫do da aula
                const conteudo = await gerenciador.carregarConteudoAula(aulaId);
                
                // Exibir conte√∫do
                if (conteudoElement) {
                    conteudoElement.innerHTML = conteudo;
                }
                
                // Marcar como conclu√≠da
                gerenciador.salvarProgresso(aulaId);
                
                // Atualizar visual da lista de aulas
                const aulaElement = document.querySelector(`[data-aula-id="${aulaId}"]`);
                if (aulaElement) {
                    aulaElement.classList.add('completa');
                    const statusElement = aulaElement.querySelector('.aula-status');
                    const iconeElement = aulaElement.querySelector('.aula-icone');
                    
                    if (statusElement) {
                        statusElement.innerHTML = '<i class="fas fa-check"></i> Conclu√≠da';
                    }
                    if (iconeElement) {
                        iconeElement.innerHTML = '<i class="fas fa-check-circle"></i>';
                    }
                }
                
            } catch (error) {
                console.error('Erro ao iniciar aula:', error);
                const conteudoElement = document.getElementById('aula-conteudo');
                if (conteudoElement) {
                    conteudoElement.innerHTML = `
                        <div style="text-align:center; padding: 50px 20px; color:var(--danger);">
                            <i class="fas fa-exclamation-triangle" style="font-size:3rem; margin-bottom:20px;"></i>
                            <h3>Erro ao iniciar a aula</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        };

        window.fecharAula = function() {
            const modal = document.getElementById('aula-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        };

        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharAula();
            }
        });

        // Fechar modal ao clicar fora
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('aula-modal');
            if (modal && e.target === modal) {
                fecharAula();
            }
        });

        // INICIALIZAR
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado - Iniciando Gerenciador de Cursos');
            window.gerenciador = new GerenciadorCursos();
            window.gerenciador.carregarCurso();
        });
    </script>
</body>
</html>
