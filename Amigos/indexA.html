<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amigos - Coliseum</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #000000 0%, #2d2d2d 100%);
            min-height: 100vh;
            padding: 15px;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .btn-voltar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #ffcf00;
            color: #000;
            font-size: 24px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-voltar:hover {
            background: #e6b800;
            transform: scale(1.1);
        }

        /* CONTAINER PRINCIPAL */
        .container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* CABE√áALHO */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .Topimg {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .Topimg img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        h1 {
            color: #ffffff;
            font-size: 2.2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        /* BLOCO PRINCIPAL */
        .bloco-cinza {
            width: 100%;
            background-color: #323232;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
        }

        /* BARRA DE BUSCA */
        .search-container {
            background-color: #242424;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #555;
        }

        .buscfriends {
            width: 50px;
            height: 50px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .buscfriends img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .buscfriends:hover img {
            transform: scale(1.1);
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 16px;
            padding: 10px 0;
            outline: none;
        }

        .search-input::placeholder {
            color: #888;
        }

        /* BOT√ÉO ADICIONAR AMIGO */
        .add-friend-btn {
            background: #242424;
            border: 2px dashed #555;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .add-friend-btn:hover {
            border-color: #ffcf00;
            background: #2a2a2a;
        }

        .addfriends {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .addfriends img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .add-friend-btn:hover .addfriends img {
            transform: scale(1.1);
        }

        .add-friend-text {
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
        }

        /* LISTA DE AMIGOS */
        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .friend-item {
            background: #242424;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #555;
            transition: all 0.3s ease;
        }

        .friend-item:hover {
            border-color: #ffcf00;
            transform: translateY(-2px);
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffcf00, #ffaa00);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .friend-details {
            color: #888;
            font-size: 14px;
        }

        .friend-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .status-online {
            color: #00ff00;
        }

        .status-offline {
            color: #888;
        }

        .friend-actions {
            display: flex;
            gap: 10px;
        }

        .btn-action {
            background: #323232;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-chat:hover {
            background: #ffcf00;
            color: #000;
        }

        .btn-remove:hover {
            background: #ff4444;
            color: #fff;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #323232;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #555;
        }

        .modal h2 {
            color: #ffffff;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            background: #242424;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 12px 15px;
            color: #ffffff;
            font-size: 16px;
            margin-bottom: 15px;
            outline: none;
        }

        .modal-input:focus {
            border-color: #ffcf00;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #555;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-confirm {
            background: #ffcf00;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .empty-state img {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* DEBUG INFO */
        .debug-info {
            background: #1a1a1a;
            border: 1px solid #ffcf00;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #ffcf00;
        }

        .debug-info h4 {
            margin-bottom: 10px;
            color: #ffcf00;
        }

        .debug-info p {
            margin: 5px 0;
        }

        .debug-btn {
            background: #ffcf00;
            color: #000;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .Topimg {
                width: 100px;
                height: 100px;
            }
            
            .friend-item {
                padding: 12px;
            }
            
            .friend-avatar {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }

            .btn-voltar {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 15px;
                right: 15px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            .bloco-cinza {
                padding: 15px;
            }
            
            .search-container {
                padding: 12px;
            }
            
            .buscfriends {
                width: 40px;
                height: 40px;
            }
            
            .addfriends {
                width: 60px;
                height: 60px;
            }
            
            .friend-actions {
                flex-direction: column;
                gap: 5px;
            }
            
            .btn-action {
                padding: 6px 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- CABE√áALHO -->
        <div class="header">
            <div class="Topimg">
                <div style="
                    width: 100px; 
                    height: 100px; 
                    background: #ffcf00; 
                    border-radius: 50%; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    font-size: 40px;
                    border: 3px solid #fff;
                    box-shadow: 0 4px 15px rgba(255, 207, 0, 0.3);
                ">
                    üë•
                </div>
            </div>
            <h1>Amigos</h1>
            <div id="debugHeader" class="debug-info" style="display: none;">
                <h4>üîß Modo Debug</h4>
                <p id="debugUserInfo"></p>
                <button class="debug-btn" onclick="toggleDebugMode()">Alternar Debug</button>
            </div>
        </div>

        <!-- BLOCO PRINCIPAL -->
        <div class="bloco-cinza">
            <!-- BARRA DE BUSCA -->
            <div class="search-container">
                <div class="buscfriends" onclick="abrirModalBuscar()">
                    <div style="
                        width: 40px; 
                        height: 40px; 
                        background: #ffcf00; 
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-size: 18px;
                        color: #000;
                    ">
                        üîç
                    </div>
                </div>
                <input type="text" class="search-input" placeholder="Buscar amigos..." id="searchInput" oninput="filtrarAmigos(this.value)">
            </div>

            <!-- BOT√ÉO ADICIONAR AMIGO -->
            <div class="add-friend-btn" onclick="abrirModalAdicionar()">
                <div class="addfriends">
                    <div style="
                        width: 60px; 
                        height: 60px; 
                        background: #ffcf00; 
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-size: 24px;
                        color: #000;
                    ">
                        ‚ûï
                    </div>
                </div>
                <div class="add-friend-text">Adicionar Amigo</div>
            </div>

            <!-- LISTA DE AMIGOS -->
            <div class="friends-list" id="friendsList">
                <div class="empty-state">
                    <div style="
                        width: 80px; 
                        height: 80px; 
                        background: #555; 
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-size: 32px;
                        color: #888;
                        margin: 0 auto 15px;
                    ">
                        ‚è≥
                    </div>
                    <p>Carregando amigos...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ADICIONAR AMIGO -->
    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <h2>Adicionar Amigo</h2>
            <input type="text" class="modal-input" id="friendNameInput" placeholder="Nome do amigo">
            <input type="text" class="modal-input" id="friendRAInput" placeholder="RA do amigo (4 d√≠gitos)">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="fecharModal()">Cancelar</button>
                <button class="btn-confirm" onclick="adicionarAmigo()">Adicionar</button>
            </div>
            <div id="addFriendDebug" style="margin-top: 15px; font-size: 12px; color: #888; display: none;">
                <p>Debug info aparecer√° aqui</p>
            </div>
        </div>
    </div>

    <!-- MODAL BUSCAR AMIGO -->
    <div class="modal" id="searchFriendModal">
        <div class="modal-content">
            <h2>Buscar Amigo</h2>
            <input type="text" class="modal-input" id="searchFriendInput" placeholder="Digite o nome ou RA">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="fecharModal()">Cancelar</button>
                <button class="btn-confirm" onclick="realizarBusca()">Buscar</button>
            </div>
        </div>
    </div>

    <!-- DEBUG PANEL (inicialmente oculto) -->
    <div id="debugPanel" style="
        position: fixed;
        bottom: 100px;
        right: 20px;
        background: rgba(0,0,0,0.9);
        border: 1px solid #ffcf00;
        border-radius: 10px;
        padding: 15px;
        width: 300px;
        max-height: 400px;
        overflow-y: auto;
        display: none;
        z-index: 999;
        color: white;
        font-size: 12px;
    ">
        <h4 style="color: #ffcf00; margin-bottom: 10px;">üîß Console Debug</h4>
        <div id="debugLog" style="margin-bottom: 10px; max-height: 300px; overflow-y: auto;">
            <p>> Sistema iniciado...</p>
        </div>
        <input type="text" id="debugCommand" placeholder="Digite um comando" style="
            width: 100%;
            padding: 5px;
            background: #323232;
            border: 1px solid #555;
            color: white;
            border-radius: 5px;
            margin-bottom: 10px;
        ">
        <button onclick="executeDebugCommand()" style="
            background: #ffcf00;
            color: #000;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
        ">Executar</button>
        <button onclick="clearDebugLog()" style="
            background: #555;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 11px;
        ">Limpar</button>
    </div>

    <button class="btn-voltar" onclick="history.back()">‚Üê</button>
    <button id="debugToggle" onclick="toggleDebugPanel()" style="
        position: fixed;
        bottom: 100px;
        left: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ff4444;
        color: white;
        border: none;
        cursor: pointer;
        z-index: 999;
        font-size: 20px;
    ">üêõ</button>

    <script>
        // ============================================
        // SISTEMA DE AMIGOS - COMPLETO
        // ============================================
        
        // Configura√ß√µes
        const CONFIG = {
            API_URL: 'https://coliseum-api.onrender.com',
            // API_URL: 'http://localhost:10000', // Para desenvolvimento local
            DEBUG_MODE: true,
            MAX_LOG_ENTRIES: 50
        };

        // Estado global
        let sistemaAmigos = null;
        let debugLog = [];
        let debugPanelVisible = false;

        // ============================================
        // FUN√á√ïES DE DEBUG
        // ============================================
        
        function logDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            debugLog.push(logEntry);
            
            if (debugLog.length > CONFIG.MAX_LOG_ENTRIES) {
                debugLog.shift();
            }
            
            // Atualizar painel de debug se vis√≠vel
            if (debugPanelVisible) {
                updateDebugPanel();
            }
            
            // Log no console tamb√©m
            const colors = {
                info: 'color: #3498db',
                success: 'color: #2ecc71',
                error: 'color: #e74c3c',
                warning: 'color: #f39c12'
            };
            console.log(`%c[${timestamp}] ${message}`, colors[type] || colors.info);
        }

        function updateDebugPanel() {
            const debugElement = document.getElementById('debugLog');
            if (!debugElement) return;
            
            debugElement.innerHTML = debugLog.map(entry => {
                const color = entry.type === 'error' ? '#e74c3c' : 
                             entry.type === 'success' ? '#2ecc71' : 
                             entry.type === 'warning' ? '#f39c12' : '#3498db';
                return `<p style="color: ${color}; margin: 2px 0;">[${entry.timestamp}] ${entry.message}</p>`;
            }).join('');
            
            debugElement.scrollTop = debugElement.scrollHeight;
        }

        function toggleDebugPanel() {
            debugPanelVisible = !debugPanelVisible;
            document.getElementById('debugPanel').style.display = debugPanelVisible ? 'block' : 'none';
            document.getElementById('debugToggle').style.background = debugPanelVisible ? '#2ecc71' : '#ff4444';
            
            if (debugPanelVisible) {
                updateDebugPanel();
            }
        }

        function toggleDebugMode() {
            CONFIG.DEBUG_MODE = !CONFIG.DEBUG_MODE;
            document.getElementById('debugHeader').style.display = CONFIG.DEBUG_MODE ? 'block' : 'none';
            logDebug(`Modo debug ${CONFIG.DEBUG_MODE ? 'ativado' : 'desativado'}`, 'info');
        }

        function executeDebugCommand() {
            const commandInput = document.getElementById('debugCommand');
            const command = commandInput.value.trim();
            
            if (!command) return;
            
            logDebug(`> ${command}`, 'info');
            commandInput.value = '';
            
            // Comandos dispon√≠veis
            const commands = {
                'test api': testAPIConnection,
                'list users': listAllUsers,
                'clear cache': clearLocalStorage,
                'reload': () => location.reload(),
                'help': showDebugHelp,
                'status': showSystemStatus
            };
            
            if (commands[command]) {
                commands[command]();
            } else {
                logDebug(`Comando desconhecido: ${command}`, 'error');
            }
        }

        function clearDebugLog() {
            debugLog = [];
            updateDebugPanel();
            logDebug('Log limpo', 'info');
        }

        // ============================================
        // FUN√á√ïES AUXILIARES
        // ============================================
        
        async function testAPIConnection() {
            logDebug('Testando conex√£o com API...', 'info');
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/health`);
                const data = await response.json();
                logDebug(`‚úÖ API Online: ${data.status}`, 'success');
                logDebug(`üìä Usu√°rios: ${data.totalUsuarios || 0}`, 'info');
                logDebug(`ü§ù Amizades: ${data.totalAmizades || 0}`, 'info');
            } catch (error) {
                logDebug(`‚ùå API Offline: ${error.message}`, 'error');
            }
        }

        async function listAllUsers() {
            logDebug('Buscando todos os usu√°rios...', 'info');
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/usuarios`);
                const usuarios = await response.json();
                logDebug(`‚úÖ ${usuarios.length} usu√°rios encontrados:`, 'success');
                usuarios.slice(0, 5).forEach(user => {
                    logDebug(`  üë§ ${user.nome} (RA: ${user.ra}, ID: ${user.id})`, 'info');
                });
                if (usuarios.length > 5) {
                    logDebug(`  ... e mais ${usuarios.length - 5} usu√°rios`, 'info');
                }
            } catch (error) {
                logDebug(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        function clearLocalStorage() {
            const amigos = JSON.parse(localStorage.getItem('amigos') || '[]');
            localStorage.removeItem('amigos');
            logDebug(`üóëÔ∏è Cache limpo (${amigos.length} amigos removidos)`, 'warning');
            if (sistemaAmigos) {
                sistemaAmigos.carregarAmigos();
            }
        }

        function showDebugHelp() {
            logDebug('Comandos dispon√≠veis:', 'info');
            logDebug('  test api      - Testa conex√£o com a API', 'info');
            logDebug('  list users    - Lista todos os usu√°rios', 'info');
            logDebug('  clear cache   - Limpa cache local', 'info');
            logDebug('  reload        - Recarrega a p√°gina', 'info');
            logDebug('  status        - Mostra status do sistema', 'info');
            logDebug('  help          - Mostra esta ajuda', 'info');
        }

        function showSystemStatus() {
            const userId = localStorage.getItem('userId');
            const userName = localStorage.getItem('userName');
            const amigos = JSON.parse(localStorage.getItem('amigos') || '[]');
            
            logDebug('Status do Sistema:', 'info');
            logDebug(`üë§ Usu√°rio: ${userName || 'N√£o logado'}`, userId ? 'success' : 'error');
            logDebug(`üÜî ID: ${userId || 'N√£o definido'}`, userId ? 'success' : 'error');
            logDebug(`üíæ Cache: ${amigos.length} amigos`, 'info');
            logDebug(`üåê API: ${CONFIG.API_URL}`, 'info');
        }

        // ============================================
        // CLASSE PRINCIPAL DO SISTEMA
        // ============================================
        
        class SistemaAmigos {
            constructor() {
                this.usuarioId = localStorage.getItem('userId');
                this.usuarioNome = localStorage.getItem('userName');
                this.amigos = [];
                this.inicializar();
            }

            inicializar() {
                logDebug('Sistema de amigos inicializando...', 'info');
                logDebug(`Usu√°rio: ${this.usuarioNome} (ID: ${this.usuarioId})`, 
                    this.usuarioId ? 'success' : 'warning');
                
                this.atualizarInfoDebug();
                
                if (this.usuarioId) {
                    this.carregarAmigos();
                } else {
                    this.mostrarMensagemLogin();
                }
                
                this.configurarEventos();
                this.testarConexaoInicial();
            }

            atualizarInfoDebug() {
                const debugInfo = document.getElementById('debugUserInfo');
                if (debugInfo) {
                    debugInfo.innerHTML = `
                        <p>üë§ ${this.usuarioNome || 'N√£o logado'}</p>
                        <p>üÜî ${this.usuarioId || 'N√£o definido'}</p>
                        <p>üíæ ${JSON.parse(localStorage.getItem('amigos') || '[]').length} amigos no cache</p>
                    `;
                }
            }

            async testarConexaoInicial() {
                try {
                    const response = await fetch(`${CONFIG.API_URL}/api/health`);
                    const data = await response.json();
                    logDebug(`‚úÖ API conectada: ${data.status}`, 'success');
                } catch (error) {
                    logDebug(`‚ö†Ô∏è API pode estar offline`, 'warning');
                }
            }

            async carregarAmigos() {
                if (!this.usuarioId) {
                    logDebug('N√£o h√° usu√°rio logado', 'warning');
                    return;
                }

                logDebug(`Carregando amigos do usu√°rio ${this.usuarioId}...`, 'info');

                try {
                    const response = await fetch(`${CONFIG.API_URL}/api/amigos/usuarios/${this.usuarioId}/amigos`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    logDebug(`Resposta da API: ${JSON.stringify(data).substring(0, 100)}...`, 'info');
                    
                    if (data.success) {
                        this.amigos = data.amigos || [];
                        logDebug(`${this.amigos.length} amigos carregados`, 'success');
                        this.renderizarAmigos();
                        // Salvar no cache local
                        localStorage.setItem('amigos', JSON.stringify(this.amigos));
                    } else {
                        logDebug(`Erro na resposta: ${data.error || 'Desconhecido'}`, 'error');
                        this.carregarAmigosFallback();
                    }
                } catch (error) {
                    logDebug(`Erro ao carregar amigos: ${error.message}`, 'error');
                    this.carregarAmigosFallback();
                }
            }

            carregarAmigosFallback() {
                logDebug('Usando cache local como fallback', 'warning');
                this.amigos = JSON.parse(localStorage.getItem('amigos')) || [];
                this.renderizarAmigos();
            }

            renderizarAmigos() {
                const friendsList = document.getElementById('friendsList');
                
                if (!this.usuarioId) {
                    this.mostrarMensagemLogin();
                    return;
                }

                if (this.amigos.length === 0) {
                    friendsList.innerHTML = `
                        <div class="empty-state">
                            <div style="
                                width: 80px; 
                                height: 80px; 
                                background: #555; 
                                border-radius: 50%; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                font-size: 32px;
                                color: #888;
                                margin: 0 auto 15px;
                            ">
                                üë•
                            </div>
                            <p>Nenhum amigo adicionado ainda</p>
                            <p style="font-size: 12px; margin-top: 10px;">Clique em "Adicionar Amigo" para come√ßar</p>
                            ${CONFIG.DEBUG_MODE ? `
                            <div style="margin-top: 20px; font-size: 11px; color: #ffcf00;">
                                <p>üí° Dica: Use o bot√£o üêõ para debug</p>
                            </div>` : ''}
                        </div>
                    `;
                    return;
                }

                friendsList.innerHTML = this.amigos.map(amigo => `
                    <div class="friend-item" data-id="${amigo.amigo?.id || amigo.id}">
                        <div class="friend-avatar">
                            ${(amigo.amigo?.nome || amigo.nome || '?').charAt(0).toUpperCase()}
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${amigo.amigo?.nome || amigo.nome || 'Amigo'}</div>
                            <div class="friend-details">
                                RA: ${amigo.amigo?.ra || amigo.ra || 'N/A'} ‚Ä¢ 
                                S√©rie: ${amigo.amigo?.serie || amigo.serie || 'N√£o informada'}
                            </div>
                            <div class="friend-status">
                                <span class="status-online">‚óè</span> Online
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn-action btn-chat" onclick="sistemaAmigos.iniciarChat('${amigo.amigo?.id || amigo.id}')">
                                üí¨ Chat
                            </button>
                            <button class="btn-action btn-remove" onclick="sistemaAmigos.removerAmigo('${amigo.amigo?.id || amigo.id}')">
                                üóëÔ∏è Remover
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            mostrarMensagemLogin() {
                const friendsList = document.getElementById('friendsList');
                friendsList.innerHTML = `
                    <div class="empty-state">
                        <div style="
                            width: 80px; 
                            height: 80px; 
                            background: #555; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-size: 32px;
                            color: #888;
                            margin: 0 auto 15px;
                        ">
                            üîí
                        </div>
                        <p>Fa√ßa login para ver seus amigos</p>
                        <p style="font-size: 12px; margin-top: 10px;">Voc√™ precisa estar logado para acessar o sistema de amigos</p>
                        <button onclick="window.location.href='/login'" style="
                            background: #ffcf00;
                            color: #000;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            margin-top: 15px;
                            cursor: pointer;
                            font-weight: bold;
                        ">
                            Ir para Login
                        </button>
                    </div>
                `;
            }

            configurarEventos() {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.filtrarAmigos(e.target.value);
                    });
                }

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.fecharModal();
                    }
                });
            }

            filtrarAmigos(termo) {
                if (!termo) {
                    this.renderizarAmigos();
                    return;
                }

                const amigosFiltrados = this.amigos.filter(amigo => {
                    const nome = amigo.amigo?.nome || amigo.nome || '';
                    const ra = amigo.amigo?.ra || amigo.ra || '';
                    return nome.toLowerCase().includes(termo.toLowerCase()) ||
                           ra.includes(termo);
                });

                const friendsList = document.getElementById('friendsList');
                
                if (amigosFiltrados.length === 0) {
                    friendsList.innerHTML = `
                        <div class="empty-state">
                            <p>Nenhum amigo encontrado</p>
                            <p style="font-size: 12px; margin-top: 5px;">Tente outro termo de busca</p>
                        </div>
                    `;
                    return;
                }

                friendsList.innerHTML = amigosFiltrados.map(amigo => `
                    <div class="friend-item" data-id="${amigo.amigo?.id || amigo.id}">
                        <div class="friend-avatar">
                            ${(amigo.amigo?.nome || amigo.nome || '?').charAt(0).toUpperCase()}
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${amigo.amigo?.nome || amigo.nome || 'Amigo'}</div>
                            <div class="friend-details">
                                RA: ${amigo.amigo?.ra || amigo.ra || 'N/A'} ‚Ä¢ 
                                S√©rie: ${amigo.amigo?.serie || amigo.serie || 'N√£o informada'}
                            </div>
                            <div class="friend-status">
                                <span class="status-online">‚óè</span> Online
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn-action btn-chat" onclick="sistemaAmigos.iniciarChat('${amigo.amigo?.id || amigo.id}')">
                                üí¨ Chat
                            </button>
                            <button class="btn-action btn-remove" onclick="sistemaAmigos.removerAmigo('${amigo.amigo?.id || amigo.id}')">
                                üóëÔ∏è Remover
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            abrirModalAdicionar() {
                if (!this.usuarioId) {
                    alert('‚ö†Ô∏è Fa√ßa login para adicionar amigos!');
                    window.location.href = '/login';
                    return;
                }
                
                logDebug('Abrindo modal de adicionar amigo', 'info');
                document.getElementById('addFriendModal').style.display = 'flex';
                document.getElementById('friendNameInput').focus();
            }

            abrirModalBuscar() {
                logDebug('Abrindo modal de busca', 'info');
                document.getElementById('searchFriendModal').style.display = 'flex';
                document.getElementById('searchFriendInput').focus();
            }

            fecharModal() {
                document.getElementById('addFriendModal').style.display = 'none';
                document.getElementById('searchFriendModal').style.display = 'none';
                
                document.getElementById('friendNameInput').value = '';
                document.getElementById('friendRAInput').value = '';
                document.getElementById('searchFriendInput').value = '';
                
                document.getElementById('addFriendDebug').style.display = 'none';
                document.getElementById('addFriendDebug').innerHTML = '<p>Debug info aparecer√° aqui</p>';
            }

            async adicionarAmigo() {
                if (!this.usuarioId) {
                    alert('‚ö†Ô∏è Fa√ßa login para adicionar amigos!');
                    return;
                }

                const nome = document.getElementById('friendNameInput').value.trim();
                const ra = document.getElementById('friendRAInput').value.trim();
                const debugDiv = document.getElementById('addFriendDebug');

                logDebug(`Tentando adicionar amigo: ${nome} (RA: ${ra})`, 'info');

                if (!nome || !ra) {
                    alert('‚ö†Ô∏è Por favor, preencha nome e RA do amigo!');
                    return;
                }

                // Validar RA (4 d√≠gitos)
                if (!/^\d{4}$/.test(ra)) {
                    alert('‚ùå RA inv√°lido! Deve conter exatamente 4 d√≠gitos.');
                    return;
                }

                debugDiv.style.display = 'block';
                debugDiv.innerHTML = '<p>üîç Buscando usu√°rio...</p>';

                try {
                    // 1. Buscar usu√°rio pelo RA
                    logDebug(`Buscando usu√°rio com RA: ${ra}`, 'info');
                    const searchResponse = await fetch(
                        `${CONFIG.API_URL}/api/amigos/usuarios/buscar?query=${encodeURIComponent(ra)}&usuarioId=${this.usuarioId}`
                    );

                    if (!searchResponse.ok) {
                        throw new Error(`HTTP ${searchResponse.status}: ${await searchResponse.text()}`);
                    }

                    const searchData = await searchResponse.json();
                    logDebug(`Resultado da busca: ${JSON.stringify(searchData)}`, 'info');

                    debugDiv.innerHTML = `
                        <p>‚úÖ Busca realizada</p>
                        <p>Resultados: ${searchData.resultados?.length || 0}</p>
                    `;

                    if (!searchData.success || !searchData.resultados || searchData.resultados.length === 0) {
                        debugDiv.innerHTML += '<p style="color: #ff4444;">‚ùå Nenhum usu√°rio encontrado com este RA</p>';
                        alert('‚ùå Nenhum usu√°rio encontrado com este RA!');
                        return;
                    }

                    // 2. Encontrar usu√°rio exato
                    const usuarioEncontrado = searchData.resultados.find(u => u.ra === ra);
                    
                    if (!usuarioEncontrado) {
                        debugDiv.innerHTML += '<p style="color: #ff4444;">‚ùå RA n√£o encontrado (usu√°rio pode ter RA diferente)</p>';
                        alert('‚ùå RA n√£o encontrado! Verifique se o RA est√° correto.');
                        return;
                    }

                    debugDiv.innerHTML += `
                        <p>‚úÖ Usu√°rio encontrado: ${usuarioEncontrado.nome}</p>
                        <p>Status de amizade: ${usuarioEncontrado.statusAmizade || 'Nenhum'}</p>
                    `;

                    // 3. Verificar status de amizade
                    if (usuarioEncontrado.statusAmizade === 'aceito') {
                        debugDiv.innerHTML += '<p style="color: #00ff00;">‚úÖ Voc√™s j√° s√£o amigos!</p>';
                        alert('‚úÖ Voc√™s j√° s√£o amigos!');
                        this.fecharModal();
                        return;
                    }

                    if (usuarioEncontrado.statusAmizade === 'pendente') {
                        debugDiv.innerHTML += '<p style="color: #ffcf00;">üì© Solicita√ß√£o j√° enviada!</p>';
                        alert('üì© J√° existe uma solicita√ß√£o pendente para este usu√°rio!');
                        this.fecharModal();
                        return;
                    }

                    // 4. Enviar solicita√ß√£o de amizade
                    debugDiv.innerHTML += '<p>üì§ Enviando solicita√ß√£o de amizade...</p>';
                    
                    const addResponse = await fetch(
                        `${CONFIG.API_URL}/api/amigos/usuarios/${this.usuarioId}/solicitar/${usuarioEncontrado.id}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            }
                        }
                    );

                    const addData = await addResponse.json();
                    logDebug(`Resposta da solicita√ß√£o: ${JSON.stringify(addData)}`, 'info');

                    if (addResponse.ok && addData.success) {
                        debugDiv.innerHTML += '<p style="color: #00ff00;">‚úÖ Solicita√ß√£o enviada com sucesso!</p>';
                        logDebug(`Solicita√ß√£o enviada para ${usuarioEncontrado.nome}`, 'success');
                        
                        alert(`‚úÖ Solicita√ß√£o enviada para ${usuarioEncontrado.nome}!`);
                        this.fecharModal();
                        this.carregarAmigos();
                    } else {
                        const errorMsg = addData.error || addData.details || 'Erro desconhecido';
                        debugDiv.innerHTML += `<p style="color: #ff4444;">‚ùå ${errorMsg}</p>`;
                        logDebug(`Erro ao enviar solicita√ß√£o: ${errorMsg}`, 'error');
                        alert(`‚ùå Erro: ${errorMsg}`);
                    }

                } catch (error) {
                    debugDiv.innerHTML += `<p style="color: #ff4444;">‚ùå Erro: ${error.message}</p>`;
                    logDebug(`Erro ao adicionar amigo: ${error.message}`, 'error');
                    alert(`‚ùå Erro ao adicionar amigo: ${error.message}`);
                }
            }

            async realizarBusca() {
                const termo = document.getElementById('searchFriendInput').value.trim();
                
                if (!termo) {
                    alert('‚ö†Ô∏è Por favor, digite um nome ou RA para buscar!');
                    return;
                }

                logDebug(`Buscando por: "${termo}"`, 'info');

                try {
                    const response = await fetch(
                        `${CONFIG.API_URL}/api/amigos/usuarios/buscar?query=${encodeURIComponent(termo)}&usuarioId=${this.usuarioId}`
                    );
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    logDebug(`Resultados da busca: ${data.resultados?.length || 0} encontrados`, 'info');

                    if (data.success && data.resultados && data.resultados.length > 0) {
                        this.mostrarResultadosBusca(data.resultados);
                    } else {
                        alert('‚ùå Nenhum usu√°rio encontrado com esses dados.');
                    }

                } catch (error) {
                    logDebug(`Erro na busca: ${error.message}`, 'error');
                    alert('‚ùå Erro ao buscar usu√°rios. Tente novamente.');
                }
                
                this.fecharModal();
            }

            mostrarResultadosBusca(resultados) {
                const modalHTML = `
                    <div style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.9);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 3000;
                    ">
                        <div style="
                            background: #323232;
                            padding: 25px;
                            border-radius: 15px;
                            color: white;
                            width: 90%;
                            max-width: 500px;
                            max-height: 80vh;
                            overflow-y: auto;
                            border: 1px solid #555;
                        ">
                            <h3 style="margin-bottom: 20px; color: #ffcf00;">üîç Resultados da Busca (${resultados.length})</h3>
                            <div style="margin-bottom: 20px;">
                                ${resultados.map(user => `
                                    <div style="
                                        background: #242424;
                                        border-radius: 12px;
                                        padding: 15px;
                                        margin-bottom: 10px;
                                        border: 1px solid #555;
                                    ">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong style="color: #ffcf00;">${user.nome}</strong><br>
                                                <small style="color: #888;">RA: ${user.ra} ‚Ä¢ S√©rie: ${user.serie || 'N√£o informada'}</small>
                                            </div>
                                            ${user.statusAmizade ? 
                                                `<span style="color: ${user.statusAmizade === 'aceito' ? '#00ff00' : '#ffcf00'}; font-size: 12px;">
                                                    ${user.statusAmizade === 'aceito' ? '‚úÖ Amigo' : 'üì© Pendente'}
                                                </span>` :
                                                `<button onclick="adicionarAmigoBusca(${user.id}, '${user.nome.replace(/'/g, "\\'")}')" 
                                                    style="
                                                        background: #ffcf00;
                                                        color: #000;
                                                        border: none;
                                                        padding: 8px 15px;
                                                        border-radius: 6px;
                                                        cursor: pointer;
                                                        font-weight: bold;
                                                        font-size: 12px;
                                                    ">
                                                    Adicionar
                                                </button>`
                                            }
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="text-align: center;">
                                <button onclick="this.parentElement.parentElement.remove()" 
                                    style="
                                        background: #555;
                                        color: white;
                                        border: none;
                                        padding: 10px 20px;
                                        border-radius: 8px;
                                        cursor: pointer;
                                    ">
                                    Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const modalDiv = document.createElement('div');
                modalDiv.innerHTML = modalHTML;
                document.body.appendChild(modalDiv.firstElementChild);
            }

            async removerAmigo(amigoId) {
                if (!confirm('‚ö†Ô∏è Tem certeza que deseja remover este amigo?')) {
                    return;
                }

                logDebug(`Removendo amigo ID: ${amigoId}`, 'info');

                try {
                    const response = await fetch(
                        `${CONFIG.API_URL}/api/amigos/usuarios/${this.usuarioId}/amigos/${amigoId}`,
                        { method: 'DELETE' }
                    );

                    const data = await response.json();
                    
                    if (data.success) {
                        logDebug(`Amigo ${amigoId} removido`, 'success');
                        alert('‚úÖ Amigo removido com sucesso!');
                        this.carregarAmigos();
                    } else {
                        logDebug(`Erro ao remover: ${data.error || data.details}`, 'error');
                        alert(`‚ùå Erro: ${data.error || data.details}`);
                    }
                } catch (error) {
                    logDebug(`Erro ao remover amigo: ${error.message}`, 'error');
                    alert('‚ùå Erro ao remover amigo. Tente novamente.');
                }
            }

            iniciarChat(amigoId) {
                const amigo = this.amigos.find(a => (a.amigo?.id || a.id) === parseInt(amigoId));
                if (amigo) {
                    logDebug(`Iniciando chat com amigo ID: ${amigoId}`, 'info');
                    localStorage.setItem('chatAmigo', JSON.stringify(amigo.amigo || amigo));
                    window.location.href = `/chat?amigoId=${amigoId}`;
                } else {
                    alert('Amigo n√£o encontrado!');
                }
            }
        }

        // ============================================
        // FUN√á√ïES GLOBAIS
        // ============================================
        
        function adicionarAmigoBusca(amigoId, amigoNome) {
            if (!sistemaAmigos || !sistemaAmigos.usuarioId) {
                alert('‚ö†Ô∏è Fa√ßa login para adicionar amigos!');
                return;
            }

            logDebug(`Adicionando amigo da busca: ${amigoNome} (ID: ${amigoId})`, 'info');
            
            // Remover modal de resultados
            const resultModal = document.querySelector('div[style*="background: rgba(0,0,0,0.9)"]');
            if (resultModal) {
                resultModal.remove();
            }

            // Enviar solicita√ß√£o
            fetch(`${CONFIG.API_URL}/api/amigos/usuarios/${sistemaAmigos.usuarioId}/solicitar/${amigoId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ Solicita√ß√£o enviada para ${amigoNome}!`);
                    if (sistemaAmigos) {
                        sistemaAmigos.carregarAmigos();
                    }
                } else {
                    alert(`‚ùå Erro: ${data.error || data.details}`);
                }
            })
            .catch(error => {
                logDebug(`Erro ao adicionar amigo: ${error.message}`, 'error');
                alert('‚ùå Erro ao adicionar amigo. Tente novamente.');
            });
        }

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('P√°gina carregada', 'success');
            
            // Mostrar informa√ß√µes iniciais
            const userId = localStorage.getItem('userId');
            const userName = localStorage.getItem('userName');
            
            if (CONFIG.DEBUG_MODE) {
                document.getElementById('debugHeader').style.display = 'block';
            }
            
            if (userId && userName) {
                logDebug(`Usu√°rio logado: ${userName} (ID: ${userId})`, 'success');
                sistemaAmigos = new SistemaAmigos();
            } else {
                logDebug('Usu√°rio n√£o logado', 'warning');
                sistemaAmigos = new SistemaAmigos();
            }
            
            // Mostrar ajuda de debug se habilitado
            if (CONFIG.DEBUG_MODE) {
                setTimeout(() => {
                    logDebug('üí° Dica: Clique no bot√£o üêõ para abrir o console de debug', 'info');
                }, 1000);
            }
        });

        // ============================================
        // FUN√á√ïES DE CONTROLE DOS MODAIS
        // ============================================
        
        window.abrirModalAdicionar = function() {
            if (sistemaAmigos) sistemaAmigos.abrirModalAdicionar();
        };
        
        window.abrirModalBuscar = function() {
            if (sistemaAmigos) sistemaAmigos.abrirModalBuscar();
        };
        
        window.fecharModal = function() {
            if (sistemaAmigos) sistemaAmigos.fecharModal();
        };
        
        window.adicionarAmigo = function() {
            if (sistemaAmigos) sistemaAmigos.adicionarAmigo();
        };
        
        window.realizarBusca = function() {
            if (sistemaAmigos) sistemaAmigos.realizarBusca();
        };
        
        window.filtrarAmigos = function(termo) {
            if (sistemaAmigos) sistemaAmigos.filtrarAmigos(termo);
        };
        
        window.adicionarAmigoBusca = adicionarAmigoBusca;
        window.toggleDebugPanel = toggleDebugPanel;
        window.toggleDebugMode = toggleDebugMode;
        window.executeDebugCommand = executeDebugCommand;
        window.clearDebugLog = clearDebugLog;
    </script>
</body>
</html>
