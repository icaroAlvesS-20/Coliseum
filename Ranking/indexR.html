<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking - Coliseum</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
        background: linear-gradient(135deg, #000000 0%, #2d2d2d 100%);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
            line-height: 1.4;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: #242424;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #323232;
        }

        .title {
            color: #ffd700;
            font-size: 1.8em;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        }

        .subtitle {
            color: #ccc;
            font-size: 1em;
        }

        /* Sistema de pontuação */
        .pontuacao-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #323232;
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }

        .pontuacao-info h3 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 1.1em;
            text-align: center;
        }

        .regras-lista {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .regra-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #444;
            font-size: 0.9em;
        }

        .regra-item:last-child {
            border-bottom: none;
        }

        .regra-item span {
            color: #ccc;
        }

        .regra-item strong {
            color: #ffd700;
        }

        /* Stats container */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #323232, #3a3a3a);
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #444;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #ccc;
            font-size: 0.8em;
        }

        /* Ranking container */
        .ranking-container {
            background-color: #323232;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid #444;
        }

        .ranking-header {
            display: none;
        }

        .ranking-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .ranking-item {
            display: flex;
            flex-direction: column;
            padding: 15px;
            border-bottom: 1px solid #444;
            transition: all 0.3s ease;
            position: relative;
        }

        .ranking-item:hover {
            background-color: #3a3a3a;
            transform: translateX(5px);
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        /* Destaque para os top 3 */
        .ranking-item:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), transparent);
            border-left: 4px solid #ffd700;
        }

        .ranking-item:nth-child(2) {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.1), transparent);
            border-left: 4px solid #c0c0c0;
        }

        .ranking-item:nth-child(3) {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.1), transparent);
            border-left: 4px solid #cd7f32;
        }

        .ranking-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .posicao {
            font-weight: bold;
            font-size: 1.2em;
            min-width: 30px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .posicao-1 {
            color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #ffd700;
        }

        .posicao-2 {
            color: #c0c0c0;
            background: rgba(192, 192, 192, 0.2);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #c0c0c0;
        }

        .posicao-3 {
            color: #cd7f32;
            background: rgba(205, 127, 50, 0.2);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #cd7f32;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            margin-left: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            font-size: 1em;
            border: 2px solid #ffd700;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 1em;
            color: #fff;
        }

        .user-serie {
            color: #ccc;
            font-size: 0.8em;
        }

        .ranking-item-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            padding: 8px 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .stat-label-small {
            color: #aaa;
            font-size: 0.75em;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .stat-value {
            font-weight: 600;
            font-size: 0.9em;
        }

        .serie-value {
            color: #aaa;
        }

        .desafios-value {
            color: #4fc3f7;
        }

        .pontuacao-value {
            color: #ffd700;
            font-weight: bold;
        }

        /* Estados de loading e erro */
        .loading, .error, .no-data {
            text-align: center;
            padding: 40px;
            color: #ccc;
            font-style: italic;
        }

        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 10px;
            margin: 10px;
        }

        .no-data {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            margin: 10px;
        }

        /* Botão voltar */
        .btn-voltar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: #ffcf00;
            color: #000;
            font-size: 24px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 207, 0, 0.4);
            transition: all 0.3s ease;
        }

        .btn-voltar:hover {
            background: #e6b800;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 207, 0, 0.6);
        }

        /* Scrollbar personalizada */
        .ranking-list::-webkit-scrollbar {
            width: 6px;
        }

        .ranking-list::-webkit-scrollbar-track {
            background: #242424;
            border-radius: 3px;
        }

        .ranking-list::-webkit-scrollbar-thumb {
            background: #ffd700;
            border-radius: 3px;
        }

        .ranking-list::-webkit-scrollbar-thumb:hover {
            background: #ffed4e;
        }

        /* Animações */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ranking-item {
            animation: fadeInUp 0.5s ease-out;
        }

        .ranking-item:nth-child(1) { animation-delay: 0.1s; }
        .ranking-item:nth-child(2) { animation-delay: 0.2s; }
        .ranking-item:nth-child(3) { animation-delay: 0.3s; }
        .ranking-item:nth-child(4) { animation-delay: 0.4s; }
        .ranking-item:nth-child(5) { animation-delay: 0.5s; }

        /* Media Queries para telas maiores */
        @media (min-width: 768px) {
            body {
                padding: 20px;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
            }
            
            .container {
                max-width: 900px;
                padding: 30px;
            }
            
            .title {
                font-size: 2.5em;
            }
            
            .subtitle {
                font-size: 1.1em;
            }
            
            .stats-container {
                gap: 15px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-number {
                font-size: 2em;
            }
            
            .stat-label {
                font-size: 0.9em;
            }
            
            .ranking-header {
                display: grid;
                grid-template-columns: 80px 1fr 100px 100px 100px;
                gap: 15px;
                padding: 15px 20px;
                background-color: #1a1a1a;
                font-weight: bold;
                color: #ffd700;
                border-bottom: 1px solid #444;
            }
            
            .ranking-item {
                display: grid;
                grid-template-columns: 80px 1fr 100px 100px 100px;
                gap: 15px;
                padding: 15px 20px;
                flex-direction: row;
            }
            
            .ranking-item-header, .ranking-item-stats {
                display: contents;
            }
            
            .user-details {
                flex-direction: row;
                align-items: center;
                gap: 15px;
            }
            
            .user-serie {
                font-size: 0.9em;
                background: rgba(255, 255, 255, 0.1);
                padding: 4px 8px;
                border-radius: 12px;
            }
            
            .stat-item {
                display: contents;
                background: none;
            }
            
            .stat-label-small {
                display: none;
            }
            
            .serie, .desafios-count, .pontuacao {
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 500;
            }
            
            .serie {
                color: #aaa;
                font-size: 0.9em;
            }
            
            .desafios-count {
                color: #4fc3f7;
            }
            
            .pontuacao {
                color: #ffd700;
                font-weight: bold;
            }

            .btn-voltar {
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
        }

        /* Melhorias para telas muito pequenas */
        @media (max-width: 360px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            .title {
                font-size: 1.6em;
            }
            
            .stat-card {
                padding: 12px 8px;
            }
            
            .stat-number {
                font-size: 1.3em;
            }
            
            .ranking-item {
                padding: 12px;
            }
            
            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 0.9em;
            }
            
            .user-name {
                font-size: 0.9em;
            }
            
            .btn-voltar {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 15px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title">🏆 Ranking Coliseum</h1>
            <p class="subtitle">Top competidores da plataforma</p>
            
            <div class="pontuacao-info">
                <h3>📊 Sistema de Pontuação:</h3>
                <div class="regras-lista">
                    <div class="regra-item"><span>100% de acerto:</span> <strong>20 pontos</strong></div>
                    <div class="regra-item"><span>75% de acerto:</span> <strong>15 pontos</strong></div>
                    <div class="regra-item"><span>50% de acerto:</span> <strong> 10 pontos</strong></div>
                    <div class="regra-item"><span>25% de acerto:</span> <strong> 5 pontos</strong></div>
                    <div class="regra-item"><span>0% de acerto:</span> <strong>0 pontos</strong></div>
                </div>
            </div>
        </header>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="total-usuarios">0</div>
                <div class="stat-label">Usuários</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-desafios">0</div>
                <div class="stat-label">Desafios Completos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-pontos">0</div>
                <div class="stat-label">Pontos Conquistados</div>
            </div>
        </div>

       <div class="ranking-container">
            <div class="ranking-header">
                <span>Posição</span>
                <span>Usuário</span>
                <span>Série</span>
                <span>Desafios</span>
                <span>Pontuação</span>
            </div>
            
            <div id="ranking-list" class="ranking-list">
                <div class="loading">Carregando ranking...</div>
            </div>
        </div>
        </div>
    </div>
    <button class="btn-voltar" onclick="history.back()">←</button>

    <script>
const API_URL = 'https://coliseum-api.onrender.com';
let praticaIndexAtual = 0;

// ✅ FUNÇÃO CRÍTICA: Obter usuarioId de forma consistente
function obterUsuarioIdConsistente() {
    let usuarioId = localStorage.getItem('usuarioId');
    
    // Se não tem usuarioId válido, tentar pegar do objeto usuario
    if (!usuarioId || usuarioId === 'null' || usuarioId === 'undefined') {
        const usuarioJSON = localStorage.getItem('usuario');
        if (usuarioJSON) {
            try {
                const usuario = JSON.parse(usuarioJSON);
                usuarioId = usuario.id;
                console.log('🔍 Usuário ID encontrado no objeto usuario:', usuarioId);
                localStorage.setItem('usuarioId', usuarioId);
            } catch (e) {
                console.error('Erro ao parsear usuario:', e);
            }
        }
    }

    // ✅ VERIFICAÇÃO CRÍTICA - Se ainda não tem, criar temporário
    if (!usuarioId || usuarioId === 'null' || usuarioId === 'undefined') {
        console.error('❌ ERRO CRÍTICO: usuarioId não encontrado!');
        
        // Verificar se há dados de usuário no localStorage
        const usuarioNome = localStorage.getItem('usuarioNome');
        const usuarioLogado = localStorage.getItem('usuarioLogado');
        
        if (usuarioLogado === 'true' && usuarioNome) {
            // Usuário está logado mas sem ID - criar temporário
            usuarioId = 'temp_' + Date.now();
            console.log('🆔 Criando ID temporário:', usuarioId);
            localStorage.setItem('usuarioId', usuarioId);
        } else {
            // Usuário não está logado - redirecionar
            console.log('❌ Usuário não logado - redirecionando...');
            window.location.href = '../Login/index.html';
            return null;
        }
    }

    console.log('👤 Usando usuarioId:', usuarioId);
    return usuarioId;
}

// ✅ SISTEMA DE PONTUAÇÃO CORRIGIDO
class SistemaPontuacao {
    calcularPontuacao(acertos, totalPerguntas) {
        const porcentagemBase = (acertos / totalPerguntas) * 100;
        
        console.log(`🎯 Calculando pontuação: ${acertos}/${totalPerguntas} = ${porcentagemBase}%`);

        let pontosBase = 0;
        if (porcentagemBase >= 90) pontosBase = 20;
        else if (porcentagemBase >= 75) pontosBase = 15;
        else if (porcentagemBase >= 60) pontosBase = 10;
        else if (porcentagemBase >= 50) pontosBase = 8;
        else if (porcentagemBase >= 25) pontosBase = 5;
        else pontosBase = 2;

        // ✅ BÔNUS POR PERFEIÇÃO
        if (acertos === totalPerguntas) {
            pontosBase += 5;
            console.log('⭐ Bônus por perfeição: +5 pontos');
        }

        // ✅ BÔNUS POR SEQUÊNCIA
        const sequenciaAtual = this.getSequenciaAtual();
        if (sequenciaAtual > 1) {
            const bonusSequencia = Math.min(sequenciaAtual, 10);
            pontosBase += bonusSequencia;
            console.log(`🔥 Bônus por sequência (${sequenciaAtual}): +${bonusSequencia} pontos`);
        }

        console.log(`💰 Pontuação final calculada: ${pontosBase} pontos`);
        return pontosBase;
    }

    getSequenciaAtual() {
        const usuarioId = obterUsuarioIdConsistente();
        const sequencia = localStorage.getItem(`sequencia_${usuarioId}`) || 0;
        return parseInt(sequencia);
    }

    atualizarSequencia(acertos, totalPerguntas) {
        const usuarioId = obterUsuarioIdConsistente();
        let sequencia = this.getSequenciaAtual();
        
        if (acertos === totalPerguntas) {
            sequencia++;
            localStorage.setItem(`sequencia_${usuarioId}`, sequencia);
            console.log(`🔥 Sequência aumentada para: ${sequencia}`);
        } else {
            localStorage.setItem(`sequencia_${usuarioId}`, 0);
            console.log('💥 Sequência quebrada');
        }
        
        return sequencia;
    }
}

// ✅ QUESTIONÁRIO CORRIGIDO - FOCO NA PONTUAÇÃO
class Questionario {
    constructor() {
        this.perguntasAtuais = [];
        this.perguntaIndex = 0;
        this.acertos = 0;
        this.modal = document.getElementById('modalPerguntas');
        this.modalBody = document.getElementById('modalBody');
        
        console.log("📝 Inicializando Questionário...");
        
        if (this.modal && this.modalBody) {
            this.inicializarEventos();
        }
    }

    // ... (mantenha as funções existentes: inicializarEventos, abrirQuestionario, mostrarPergunta, adicionarEventListenersPergunta, verificarResposta, proximaPergunta)

    mostrarResultado() {
        const percentual = Math.round((this.acertos / this.perguntasAtuais.length) * 100);
        console.log(`🏁 Questionário finalizado: ${this.acertos}/${this.perguntasAtuais.length} (${percentual}%)`);
        
        const sistemaPontuacao = new SistemaPontuacao();
        const pontos = sistemaPontuacao.calcularPontuacao(this.acertos, this.perguntasAtuais.length);
        const sequencia = sistemaPontuacao.atualizarSequencia(this.acertos, this.perguntasAtuais.length);

        console.log(`🎯 Pontuação calculada: ${pontos} pontos`);

        // ✅ ENVIAR PARA O SERVIDOR E ATUALIZAR LOCALMENTE
        this.registrarPontuacaoNoServidor(this.acertos, this.perguntasAtuais.length, pontos, sequencia)
            .then((resultado) => {
                console.log('✅ Pontuação registrada com sucesso no servidor');
                this.atualizarDadosLocais(pontos);
            })
            .catch((error) => {
                console.error('❌ Erro ao registrar no servidor, salvando localmente:', error);
                this.atualizarDadosLocais(pontos);
            });
        
        this.mostrarResultadoAnimado(this.acertos, this.perguntasAtuais.length, pontos, sequencia);
    }

    // ✅ FUNÇÃO CRÍTICA: Registrar pontuação no servidor
    async registrarPontuacaoNoServidor(acertos, totalPerguntas, pontos, sequencia) {
        try {
            const usuarioId = obterUsuarioIdConsistente();
            
            if (!usuarioId) {
                throw new Error('Usuário não identificado');
            }

            console.log('🎯 Enviando desafio para servidor - usuarioId:', usuarioId);

            const usuarioNome = localStorage.getItem('usuarioNome') || 'Jogador';
            const porcentagemAcerto = Math.round((acertos / totalPerguntas) * 100);

            // ✅ DADOS CORRETOS PARA O SERVIDOR
            const dadosDesafio = {
                usuarioId: parseInt(usuarioId), // ✅ GARANTIR QUE É NÚMERO
                pontuacaoGanha: parseInt(pontos), // ✅ GARANTIR QUE É NÚMERO
                acertos: parseInt(acertos),
                totalPerguntas: parseInt(totalPerguntas),
                porcentagemAcerto: porcentagemAcerto,
                sequencia: parseInt(sequencia),
                materia: this.obterMateriaAtual(),
                data: new Date().toISOString()
            };

            console.log('📤 Dados enviados para servidor:', dadosDesafio);

            // ✅ VERIFICAÇÃO FINAL ANTES DO ENVIO
            if (isNaN(dadosDesafio.usuarioId) || isNaN(dadosDesafio.pontuacaoGanha)) {
                throw new Error('Dados inválidos para envio: usuarioId ou pontuacaoGanha não são números');
            }

            const response = await fetch(`${API_URL}/api/desafio-completo`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dadosDesafio)
            });

            console.log('📥 Status da resposta:', response.status);

            if (response.ok) {
                const result = await response.json();
                console.log('✅ Sucesso do servidor:', result.message);
                
                // ✅ ATUALIZAR DADOS LOCAIS COM A RESPOSTA DO SERVIDOR
                if (result.usuario) {
                    this.atualizarDadosDoServidor(result.usuario);
                }
                
                return result;
            } else {
                const errorText = await response.text();
                console.error('❌ Erro do servidor:', response.status, errorText);
                throw new Error(`Erro ${response.status}: ${errorText}`);
            }
            
        } catch (error) {
            console.error('❌ Erro na requisição:', error);
            throw error; // Re-lançar para tratamento no chamador
        }
    }

    // ✅ FUNÇÃO NOVA: Atualizar dados locais com resposta do servidor
    atualizarDadosDoServidor(usuario) {
        if (usuario && usuario.id) {
            // ✅ ATUALIZAR LOCALSTORAGE COM DADOS ATUALIZADOS DO SERVIDOR
            localStorage.setItem('usuarioId', usuario.id.toString());
            localStorage.setItem('usuarioPontuacao', usuario.pontuacao.toString());
            localStorage.setItem('usuarioDesafios', usuario.desafiosCompletados.toString());
            localStorage.setItem('usuarioNome', usuario.nome || 'Jogador');
            localStorage.setItem('usuarioRA', usuario.ra || '');
            localStorage.setItem('usuarioSerie', usuario.serie || '');
            
            console.log('✅ Dados atualizados do servidor:', {
                id: usuario.id,
                pontuacao: usuario.pontuacao,
                desafios: usuario.desafiosCompletados,
                nome: usuario.nome
            });
            
            // ✅ NOTIFICAR OUTRAS PÁGINAS (se existirem)
            if (window.parent && window.parent.atualizarPerfil) {
                window.parent.atualizarPerfil();
            }
        }
    }

    // ✅ FUNÇÃO MELHORADA: Atualizar dados locais (fallback offline)
    atualizarDadosLocais(pontos) {
        try {
            const pontuacaoAtual = parseInt(localStorage.getItem('usuarioPontuacao') || '0');
            const desafiosAtuais = parseInt(localStorage.getItem('usuarioDesafios') || '0');
            
            const novaPontuacao = pontuacaoAtual + pontos;
            const novosDesafios = desafiosAtuais + 1;
            
            // ✅ ATUALIZAR LOCALSTORAGE
            localStorage.setItem('usuarioPontuacao', novaPontuacao.toString());
            localStorage.setItem('usuarioDesafios', novosDesafios.toString());
            
            console.log('📊 Dados locais atualizados:', {
                pontuacaoAnterior: pontuacaoAtual,
                novaPontuacao: novaPontuacao,
                desafiosAnteriores: desafiosAtuais,
                novosDesafios: novosDesafios,
                pontosGanhos: pontos
            });
            
            // ✅ SALVAR DESAFIO PENDENTE PARA SINCRONIZAÇÃO FUTURA
            this.salvarDesafioPendente(pontos);
            
        } catch (error) {
            console.error('❌ Erro ao atualizar dados locais:', error);
        }
    }

    // ✅ FUNÇÃO NOVA: Salvar desafio pendente para sincronização
    salvarDesafioPendente(pontos) {
        try {
            const usuarioId = obterUsuarioIdConsistente();
            const usuarioNome = localStorage.getItem('usuarioNome') || 'Jogador';
            
            const desafioPendente = {
                usuarioId: usuarioId,
                usuarioNome: usuarioNome,
                pontuacaoGanha: pontos,
                acertos: this.acertos,
                totalPerguntas: this.perguntasAtuais.length,
                data: new Date().toISOString(),
                materia: this.obterMateriaAtual()
            };
            
            const desafiosPendentes = JSON.parse(localStorage.getItem('desafiosPendentes') || '[]');
            desafiosPendentes.push(desafioPendente);
            localStorage.setItem('desafiosPendentes', JSON.stringify(desafiosPendentes));
            
            console.log('💾 Desafio salvo para sincronização futura. Total pendentes:', desafiosPendentes.length);
            
        } catch (error) {
            console.error('❌ Erro ao salvar desafio pendente:', error);
        }
    }

    obterMateriaAtual() {
        if (window.gerenciadorPraticas?.praticasHoje[praticaIndexAtual]) {
            return window.gerenciadorPraticas.praticasHoje[praticaIndexAtual].materia;
        }
        return 'Desconhecida';
    }

    // ✅ FUNÇÃO MELHORADA: Mostrar resultado com confirmação
    mostrarResultadoAnimado(acertos, total, pontosTotais, sequencia) {
        const percentual = Math.round((acertos / total) * 100);
        const emoji = percentual >= 90 ? '🎉' : percentual >= 70 ? '🎯' : percentual >= 50 ? '👍' : '💪';
        
        let mensagemBonus = '';
        if (sequencia > 1) {
            mensagemBonus = `<div class="bonus-sequencia" style="color: #ffd700; margin: 10px 0; font-size: 14px;">🔥 Sequência de ${sequencia} desafios perfeitos!</div>`;
        }

        this.modalBody.innerHTML = `
            <div class="resultado-final">
                <div style="font-size: 48px; margin-bottom: 20px;">${emoji}</div>
                <div class="resultado-titulo">Desafio Concluído!</div>
                <div style="color: #fff; font-size: 18px; margin-bottom: 15px;">${acertos}/${total} acertos (${percentual}%)</div>
                <div class="resultado-pontuacao">
                    <div class="pontos-ganhos">+${pontosTotais} pontos</div>
                    ${mensagemBonus}
                </div>
                <div class="info-pontuacao">
                    <small>✅ Pontos registrados no seu perfil e ranking!</small>
                </div>
                <div style="margin-top: 15px; font-size: 12px; color: #ccc;">
                    Pontuação anterior: ${parseInt(localStorage.getItem('usuarioPontuacao') || '0') - pontosTotais} → Nova: ${localStorage.getItem('usuarioPontuacao')}
                </div>
                <button class="btn-reiniciar">Continuar</button>
            </div>
        `;

        setTimeout(() => {
            const btnReiniciar = this.modalBody.querySelector('.btn-reiniciar');
            if (btnReiniciar) {
                btnReiniciar.addEventListener('click', () => {
                    this.fecharModal();
                    if (window.gerenciadorPraticas) {
                        window.gerenciadorPraticas.concluirPratica(praticaIndexAtual);
                    }
                    
                    // ✅ ATUALIZAR PERFIL SE ESTIVER EM IFRAME
                    if (window.parent && window.parent.carregarPerfilUsuario) {
                        window.parent.carregarPerfilUsuario();
                    }
                });
            }
        }, 50);
    }

    fecharModal() {
        if (this.modal) this.modal.style.display = 'none';
    }
}

// ✅ SISTEMA DE SINCRONIZAÇÃO PARA DESAFIOS PENDENTES
class SincronizadorDesafios {
    constructor() {
        this.sincronizando = false;
    }

    async sincronizarDesafiosPendentes() {
        if (this.sincronizando) return;
        
        const desafiosPendentes = JSON.parse(localStorage.getItem('desafiosPendentes') || '[]');
        if (desafiosPendentes.length === 0) return;

        console.log('🔄 Sincronizando desafios pendentes:', desafiosPendentes.length);
        this.sincronizando = true;

        try {
            for (let i = 0; i < desafiosPendentes.length; i++) {
                const desafio = desafiosPendentes[i];
                
                const dados = {
                    usuarioId: parseInt(desafio.usuarioId),
                    pontuacaoGanha: desafio.pontuacaoGanha,
                    acertos: desafio.acertos,
                    totalPerguntas: desafio.totalPerguntas,
                    porcentagemAcerto: Math.round((desafio.acertos / desafio.totalPerguntas) * 100),
                    materia: desafio.materia,
                    data: desafio.data
                };

                const response = await fetch(`${API_URL}/api/desafio-completo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                if (response.ok) {
                    console.log(`✅ Desafio sincronizado: ${desafio.acertos}/${desafio.totalPerguntas}`);
                    // Remover da lista
                    desafiosPendentes.splice(i, 1);
                    i--; // Ajustar índice após remoção
                } else {
                    console.log(`❌ Falha ao sincronizar desafio: ${response.status}`);
                    break; // Parar se encontrar erro
                }
            }

            // Atualizar localStorage com lista atualizada
            localStorage.setItem('desafiosPendentes', JSON.stringify(desafiosPendentes));
            console.log('✅ Sincronização concluída. Pendentes restantes:', desafiosPendentes.length);
            
        } catch (error) {
            console.error('❌ Erro na sincronização:', error);
        } finally {
            this.sincronizando = false;
        }
    }
}

// ✅ INICIALIZAÇÃO CORRIGIDA
document.addEventListener('DOMContentLoaded', async () => {
    console.log("🚀 Inicializando sistema de desafios...");
    
    // ✅ VERIFICAÇÃO RIGOROSA DE USUÁRIO
    const usuarioLogado = localStorage.getItem('usuarioLogado');
    const usuarioId = obterUsuarioIdConsistente();
    
    if (!usuarioLogado || usuarioLogado !== 'true' || !usuarioId) {
        console.log('❌ Usuário não está logado, redirecionando...');
        window.location.href = '../Login/index.html';
        return;
    }
    
    console.log('👤 Usuário verificado:', localStorage.getItem('usuarioNome'));
    console.log('🎯 Pontuação atual:', localStorage.getItem('usuarioPontuacao'));
    console.log('📊 Desafios completos:', localStorage.getItem('usuarioDesafios'));
    
    // ✅ INICIALIZAR SISTEMA DE SINCRONIZAÇÃO
    window.sincronizador = new SincronizadorDesafios();
    
    // ✅ SINCRONIZAR DESAFIOS PENDENTES SE HOUVER INTERNET
    setTimeout(() => {
        window.sincronizador.sincronizarDesafiosPendentes();
    }, 3000);
    
    // ✅ INICIALIZAR COMPONENTES
    window.gerenciadorPraticas = new GerenciadorPraticas();
    window.questionario = new Questionario();
    
    console.log("✅ Sistema de desafios inicializado com sucesso!");
});
    </script>
</body>
</html>
